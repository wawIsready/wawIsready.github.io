<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Eiwen的前端小站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="web前端">
<meta property="og:type" content="website">
<meta property="og:title" content="Eiwen的前端小站">
<meta property="og:url" content="https://wawisready.github.io/index.html">
<meta property="og:site_name" content="Eiwen的前端小站">
<meta property="og:description" content="web前端">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eiwen的前端小站">
<meta name="twitter:description" content="web前端">
  
    <link rel="alternate" href="/atom.xml" title="Eiwen的前端小站" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Eiwen的前端小站</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wawisready.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-从-Promise-来看-JavaScript-的异步处理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/30/从-Promise-来看-JavaScript-的异步处理/" class="article-date">
  <time datetime="2019-03-30T12:51:14.000Z" itemprop="datePublished">2019-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/30/从-Promise-来看-JavaScript-的异步处理/">从 Promise 来看 JavaScript 的异步处理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h2><p>在早期 <code>JavaScript</code> 的 <code>ES5</code> 语法中，多层函数的回调嵌套是一件让人很头疼的事儿，行内黑话一般称之为<strong>回调地狱</strong> 。</p>
<p>可能有些伙计还没遇到过此类业务场景，但是没关系，只要在前端圈里混，苍天会绕过谁呢？所以为了大家，我就举个特别常见的业务场景：</p>
<ul>
<li>有三个接口，分别为 <code>URL-A</code>, <code>URL-B</code>, <code>URL-C</code> (都是 <code>get</code> 请求)，我们需要分别向这三个接口请求获取数据。</li>
<li>请求 <code>URL-B</code> 时需要带上 <code>URL-A</code> 返回的数据，同理，请求 <code>URL-C</code> 时也要带上 <code>URL-B</code> 返回的数据。</li>
</ul>
<p>我们来看看用早期的 <code>jquery ajax</code> 会怎么处理：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="keyword">get</span>('/URL-A', function(resA)&#123;</span><br><span class="line">    <span class="comment">// do Something</span></span><br><span class="line">    $.<span class="keyword">get</span>('/URL-B?query=' + resA,function(resB)&#123;</span><br><span class="line">        <span class="comment">// do Something</span></span><br><span class="line">        $.<span class="keyword">get</span>('/URL-C?query=' + resB, function(resC)&#123;</span><br><span class="line">            <span class="comment">// do Something</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>从上面我们可以看出，这一段代码是很不健康的，为什么这么说？有以下几点理由：</p>
<ol>
<li>代码横向发展，而不是纵向变多，就像人不长高反而长胖一般，十分不健康。</li>
<li>业务逻辑不够直观，维护困难。</li>
<li>业务代码与公用代码难以抽离，函数之间强耦合，一旦报错很难快速定位问题所在。</li>
</ol>
<p>当然，我们也可以用函数内 <code>callback</code> 的形式来改写上面的这段代码，使之变得更直观些：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求 URL-C </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getURLCData</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">     $.<span class="keyword">get</span>('/URL-C?query=' + res, function(res)&#123;</span><br><span class="line">          <span class="comment">// do Something</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求 URL-B</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getURLBData</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">     $.<span class="keyword">get</span>('/URL-B?query=' + res, function(res)&#123;</span><br><span class="line">          <span class="comment">// do Something</span></span><br><span class="line">        getURLCData(res)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求 URL-A </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getURLAData</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $.<span class="keyword">get</span>('/URL-A', function(res)&#123;</span><br><span class="line">       <span class="comment">// do Something</span></span><br><span class="line">        getURLBData(res)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样我们就避免了函数的纵向发展，公共代码与业务代码也可以抽离，但是这种方式还不够直观，在复杂业务，超高并发请求下，业务代码依旧晦涩。</p>
<p>所以，在 <code>ES6</code> 中提出了 <code>Promise</code> 用来解决回调嵌套的问题。</p>
<p>以上代码的 <code>Promise</code> 改写我们在下文再讲，我们先讲讲何为 <code>Promise</code>。</p>
<h2 id="二-Promise-的基本用法"><a href="#二-Promise-的基本用法" class="headerlink" title="二. Promise 的基本用法"></a>二. <code>Promise</code> 的基本用法</h2><p>对于 <code>Promise</code> 我们可以这么理解，如果一个函数 <code>Promise</code> （数据准备好了）了，那么我们就可以 <code>then</code> 干点事情。</p>
<p><code>MDN</code> 对其有以下描述:</p>
<blockquote>
<p>Promise 对象是一个代理对象（代理一个值），被代理的值在Promise对象创建时可能是未知的。它允许你为异步操作的成功和失败分别绑定相应的处理方法（handlers）。 这让异步方法可以像同步方法那样返回值，但并不是立即返回最终执行结果，而是一个能代表未来出现的结果的promise对象</p>
</blockquote>
<p><code>Promise</code> 有以下四个函数可以调用：</p>
<ol>
<li><code>Promise.all(iterable)</code><br> 这个方法返回一个新的 promise 对象，该 promise 对象在 iterable 参数对象里所有的 promise 对象都成功的时候才会触发成功，一旦有任何一个 iterable 里面的  promise 对象失败则立即触发该 promise 对象的失败。<br> 注意，iterabe 参数为数组，数组里存放 promise 对象。</li>
<li><code>Promise.race(iterable)</code><br> 当iterable参数里的任意一个子promise被成功或失败后，父promise马上也会用子promise的成功返回值或失败详情作为参数调用父promise绑定的相应句柄，并返回该promise对象。</li>
<li><code>Promise.resolve(value)</code><br> 返回一个状态由给定value决定的Promise对象。</li>
<li><code>Promise.reject(reason)</code><br> 返回一个状态为失败的Promise对象，并将给定的失败信息传递给对应的处理方法    </li>
</ol>
<p>我们来看个例子:</p>
<p><strong>实现一个简单的定时 promise：</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delayLogNum</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'success'</span>);</span><br><span class="line">            resolve(<span class="string">'ok'</span>);</span><br><span class="line">        &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">delayLogNum().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>结果如下所示：<br><img src="https://img-blog.csdnimg.cn/2019031911564922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="三-Promise-处理串行和并行"><a href="#三-Promise-处理串行和并行" class="headerlink" title="三.Promise 处理串行和并行"></a>三.<code>Promise</code> 处理串行和并行</h2><p>在 <code>JavaScript</code> 中已经有<strong>同步</strong>,<strong>异步</strong>,<strong>串行</strong>,<strong>并行</strong>这些概念了，大家需分清楚其中的区别：</p>
<ul>
<li><strong>同步</strong>与<strong>异步</strong>是指是在 JavaScript 的主线程中执行(同步)还是丢到任务队列中执行（异步）。</li>
<li><strong>串行</strong>和<strong>并行</strong>是指在异步任务队列中的函数是按顺序一个一个执行（串行）还是所有队列中的函数一起执行，但是必须在所有函数执行完毕后再接着执行下一步。</li>
</ul>
<p>在 <code>ES7</code> 中新增加了 <code>async</code> 和 <code>await</code> 关键字：</p>
<ul>
<li><code>async</code> 用于定义一个返回 AsyncFunction 对象的异步函数。异步函数是指通过事件循环异步执行的函数，它会通过一个隐式的 Promise 返回其结果。</li>
<li><code>await</code> 操作符用于等待一个Promise 对象。它只能在异步函数 async function 中使用。</li>
</ul>
<p>ok，梳理完了前置知识点，我们来看看利用 <code>Promise</code> 和 <code>async await</code> 怎么处理串行。</p>
<p>举一个例子：遍历一个 <code>Number</code> 数组并且在每次遍历时延时 <code>1</code> 秒输出遍历的数值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delay</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(resolve, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">eachEveryVal</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">await</span> delay();</span><br><span class="line">    <span class="built_in">console</span>.log(item)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">eachArr</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> val <span class="keyword">of</span> data)&#123;</span><br><span class="line">       <span class="keyword">await</span> eachEveryVal(val)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eachArr([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br></pre></td></tr></table></figure>
<p>我们再举一个例子，就拿最开始那段代码来说，就是典型的异步串行操作，我们可以这么来改写它：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getURL</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        $.<span class="keyword">get</span>(url, res =&gt; &#123;</span><br><span class="line">            resolve(res)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> getData()&#123;</span><br><span class="line">    <span class="keyword">let</span> dataA = <span class="keyword">await</span> getURL(<span class="string">'URL-A'</span>);</span><br><span class="line">    <span class="keyword">let</span> dataB = <span class="keyword">await</span> getURL(<span class="string">'URL-B?query='</span> + dataA);</span><br><span class="line">    <span class="keyword">let</span> dataC = <span class="keyword">await</span> getURL(<span class="string">'URL-C?query='</span> + dataB);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">getData();</span><br></pre></td></tr></table></figure></p>
<p>讲完了串行，我们再来讲讲异步并行。假设我们有以下需求：</p>
<ul>
<li>有三个接口，分别为 <code>URL-A</code>, <code>URL-B</code>, <code>URL-C</code> (都是 <code>get</code> 请求)，我们需要分别向这三个接口请求获取数据。</li>
<li>在三个请求都结束后，拿到他们的数据进行业务处理。</li>
</ul>
<p>这就是一个典型的并行的业务需求，我们也可以用 <code>promise</code> 来实现它。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> URI_LIST = [<span class="string">"URL-A"</span>, <span class="string">"URL-B"</span>, <span class="string">"URL-C"</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getURL</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        $.<span class="keyword">get</span>(url, res =&gt; &#123;</span><br><span class="line">            resolve(res)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> promises = URI_LIST.map(<span class="function"><span class="params">url</span> =&gt;</span> getURL(url));</span><br><span class="line">    <span class="built_in">Promise</span>.all(promises).then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">getData();</span><br></pre></td></tr></table></figure>
<p>我大概解释下这段代码：</p>
<ul>
<li><code>getURL()</code> 函数返回一个 <code>promise</code>,并在传入 <code>url</code> 参数给 <code>$.get()</code> 调用，请求成功后调用 <code>reslove(res)</code> 来返回请求结果。</li>
<li><code>getData()</code> 函数声明一个 <code>promises</code> 来存放 <code>getURL(url)</code> 返回的 <code>promise</code> 对象，通过 <code>URI_LIST.map()</code> 来得到我们在基础用法中所讲的 <code>iterable</code> 参数对象，并将此对象传入 <code>Promise.all()</code> 中，最后通过 <code>then()</code> 获取结果。要注意的是，此结果是三个请求返回的数据组成的数组。</li>
</ul>
<h2 id="四-Promise-常见特性"><a href="#四-Promise-常见特性" class="headerlink" title="四.Promise 常见特性"></a>四.<code>Promise</code> 常见特性</h2><p>有以下5个特性需要大家理解:</p>
<ol>
<li>Promise 捕获错误与 try catch 等同.</li>
<li>Promise 拥有状态变化.</li>
<li>Promise 方法中的回调是异步的.</li>
<li>Promise 方法每次都返回一个新的 Promise.</li>
<li>Promise 会存储返回值.</li>
</ol>
<p>下面我来一一解释这 5 点特性：</p>
<p><strong>1.Promise 捕获错误与 try catch 等同</strong></p>
<p>这句话的意识就是说，在 <code>new Promise(()=&gt;{})</code> 中直接去 <code>throw err</code>,是可以通过 <code>Promise.catch()</code> 方法捕捉的，这也就意味中 <code>Promise</code> 内部也通过 <code>try catch</code> 进行了异常处理。</p>
<p><strong>2.Promise 拥有状态变化</strong></p>
<p><code>Promise</code> 有以下三种状态：</p>
<ul>
<li>pending: 初始状态，既不是成功，也不是失败状态。</li>
<li>fulfilled: 意味着操作成功完成。</li>
<li>rejected: 意味着操作失败。</li>
</ul>
<p>而 <code>Promise.resolve()</code> 和 <code>Promise.reject()</code> 都会改变 <code>promise</code> 的状态值，其中 <code>resolve</code> 会将此状态值修改为 <code>fulfilled</code>, 而 <code>reject</code> 会将此状态值修改为为 <code>rejected</code>。</p>
<p><strong>特别的，一旦 <code>Promise</code> 的状态值被改变，就会被固定，不再发生变化</strong>。也就是说只要你 <code>resolve()</code> 或者 <code>reject()</code> 了一次，在这之后无论你再调用几次这两个方法都不起效果。</p>
<p><strong>3.Promise 方法中的回调是异步的</strong></p>
<p>先解释一下，<code>Promise</code> 方法中的回调是异步的这句话中的方法是指 <code>Promise</code> 中的 <code>catch</code>,<code>then</code>,<code>finally</code>这些方法，而不是指 <code>new Promise()</code> 中的 <code>executor</code> 函数，这个函数你可以把它理解为一个立即执行函数。</p>
<p>想要真正理解 <code>Promise 方法中的回调是异步的</code>这句话，还没有这么简单，为什么这么说，因为 <code>setTimeout</code> 也是异步的，如果它们两同时存在且作用域平级，那么谁先执行，谁后执行，它们之间的竞争关系怎么确认？</p>
<p>想要了解这其中的原理，我们就需要了解一个概念：<strong>微任务（microtasks）</strong>和<strong>宏任务（tasks）</strong>。</p>
<p>我们已经知道，<code>JavaScript</code> 是单线程的操作，正是因为如此，才有了现在的同步和异步之分。在主线程中，一般是按顺序执行同步任务。而其他的异步任务则会挂起，当它们有返回值后会添加到任务队列中。等到主线程的同步任务执行完毕后，它会去任务队列中读取（按先进先出的原则）异步任务执行。以此形成一个反复的过程被称为<strong>事件循环</strong>。借用一个掘金上的图片，侵删：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319120005653.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>而在异步任务中，其实又可以细分为宏任务和微任务。</p>
<ul>
<li>宏任务可以当成了广义的异步队列中的任务，严格按照顺序压栈和执行。比如说 整体代码, <code>setTimeout</code>，<code>setInterval</code>, <code>MessageChannel</code>(Web Worker中的管道通信)。</li>
<li>微任务是当前宏任务执行完成后立即执行的任务。</li>
</ul>
<p>而在整个异步流程中，<code>JavaScript</code> 会先进入整体代码执行宏任务，然后再检查是否有微任务需要执行，如果有，则需要立即执行；如果没有则检查队列，开始执行下一批宏任务并检查微任务。借用一个掘金上的图片，侵删：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319120014205.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>总结一下， <code>Promise</code> 中的 <code>executor</code> 函数是处于主线程同步队列中执行（立即执行函数），而其他的方法诸如 <code>then</code>, <code>catch</code> 等，则是异步任务队列中的微任务，诸如 <code>setTimeout</code>,<code>setInterval</code> 等函数必须在微任务执行完毕后再开始执行。</strong></p>
<p>所以，看到这儿，整个 <code>Promise</code> 中的函数内部在整个执行栈的执行顺序和竞争关系就已经很清晰了。</p>
<p><strong>4.Promise 方法每次都返回一个新的 Promise</strong></p>
<p>这儿的意思很直白，意味着无论是 <code>then</code>,<code>catch</code> 亦或是 <code>finally</code> 都会返回   一个新的 <code>Promise</code> 对象。</p>
<p><strong>5.Promise 会存储返回值</strong></p>
<p>一般情况下我们都会这样来使用 <code>Promise</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params">flag</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            resolve(<span class="string">'success'</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            reject(<span class="string">'error'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">p(<span class="literal">true</span>).then(<span class="function"><span class="params">res</span> =&gt;</span>　<span class="built_in">console</span>.log(<span class="string">'res'</span>, res))</span><br></pre></td></tr></table></figure></p>
<p>可以看到，我们通常会把一些参数或者函数在成功状态下通过 <code>resolve()</code> 传递给 <code>then()</code> 函数来接收并作相应处理；在失败状态下通过 <code>reject()</code> 把错误信息传递给 <code>catch()</code> 函数来处理。</p>
<p><strong>特别的，如果你在 <code>Promise</code> 直接返回某些参数， <code>Pormise</code> 也会捕捉到你返回的参数并把它包装成 <code>Promise</code> 对象并传递给对应的接收函数。</strong></p>
<h2 id="五-Promise-面试题"><a href="#五-Promise-面试题" class="headerlink" title="五. Promise 面试题"></a>五. <code>Promise</code> 面试题</h2><p><strong>5.1 请用 <code>Pormise</code> 实现以下流水灯，已知红黄绿三个函数，要求红灯3秒执行一次，黄灯2秒执行一次，绿灯1秒执行一次:</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">red</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'red'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">green</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'green'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">yellow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'yellow'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delay</span>(<span class="params">time</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(resolve,time)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">runTask</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">await</span> delay(<span class="number">3000</span>);</span><br><span class="line">    red();</span><br><span class="line">    <span class="keyword">await</span> delay(<span class="number">2000</span>);</span><br><span class="line">    green();</span><br><span class="line">    <span class="keyword">await</span> delay(<span class="number">1000</span>);</span><br><span class="line">    yellow();</span><br><span class="line">    <span class="comment">// 递归循环播放</span></span><br><span class="line">    runTask()</span><br><span class="line">&#125;</span><br><span class="line">runTask();</span><br></pre></td></tr></table></figure></p>
<p><strong>5.2 请用 <code>Pormise</code> 实现 mergePromise 函数，把传进去的数组按顺序先后执行，并且把返回的数据先后放到数组 data 中：</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timeout = <span class="function"><span class="params">ms</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">    &#125;, ms);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax1 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">2000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax2 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">1000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax3 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">2000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mergePromise = <span class="function"><span class="params">ajaxArray</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在这里实现你的代码</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">mergePromise([ajax1, ajax2, ajax3]).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'done'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data); <span class="comment">// data 为 [1, 2, 3]</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要求分别输出</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// done</span></span><br><span class="line"><span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure></p>
<p>我们先分析一下题目，看到这个题目是不是就有一种很熟悉的感觉？像不像我们在上面改写的<strong>异步并行</strong>？</p>
<p>你的感觉没错，实际上这道题考查的就是让你手写一个简单的 <code>Promise.all()</code> 函数。</p>
<p>所以，我们就能知道，上题中 <code>ajaxArray</code> 参数实际上就是一个包含多个 <code>Promise</code> 对象的数组，我们可以用并行遍历的方式来处理它。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergePromise = <span class="function"><span class="params">ajaxArray</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> seq = <span class="built_in">Promise</span>.resolve();</span><br><span class="line">    <span class="keyword">let</span> data = [];</span><br><span class="line">    ajaxArray.map(<span class="function"><span class="params">func</span> =&gt;</span> &#123;</span><br><span class="line">        seq = seq.then(func).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            data.push(res);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> seq;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="六-小结"><a href="#六-小结" class="headerlink" title="六.小结"></a>六.小结</h2><p>如果你看到这了这，那么恭喜你，不管你有没有吸收其中的内容，你至少你知道了整个 <code>Promise</code> 应该怎么去学。实际上在工作中 <code>Promise</code> 的应用是很多的，包括我们使用的 <code>babel</code> 中也会有 <code>Promise-polyfill</code>。现在已经是 <code>9102</code> 年了，前端圈已经逐渐稳定下来，这意味着你我的时间已然不多，所以加油吧，伙计们。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2019/03/30/从-Promise-来看-JavaScript-的异步处理/" data-id="cjtvi069i0007uovdufjf2i4b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-UI recorder 自动化UI测试框架使用手册" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/26/UI recorder 自动化UI测试框架使用手册/" class="article-date">
  <time datetime="2018-05-26T14:04:05.000Z" itemprop="datePublished">2018-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/26/UI recorder 自动化UI测试框架使用手册/">UI recorder 自动化UI测试框架使用手册</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a><strong>一.前言</strong></h2><p>此文档为前端自动化UI测试框架 <code>UI recorder</code> 的搭建以及使用文档。</p>
<h2 id="二-准备环境"><a href="#二-准备环境" class="headerlink" title="二.准备环境"></a><strong>二.准备环境</strong></h2><!--<p class="node-title"></p>-->
<p>我们需要准备以下环境，安装顺序没有先后，环境之间相互无依赖：</p>
<ol>
<li>安装 java jdk（需要jdk 1.8及以上），并配置相应的环境变量。</li>
<li>安装 node.js 和 npm。</li>
<li>配置 npm 国内镜像 cnpm。</li>
</ol>
<p class="node-title">2.1 安装 java jdk</p>

<p>打开 <a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">java官网</a>，找到你系统对应的<code>jdk</code>版本，点击下载。如下图：<br><img src="https://img-blog.csdnimg.cn/20190328173540369.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>下载完成后傻瓜式安装，记住你的安装路径，我们添加系统环境变量时需要用到。</p>
<p>安装完成后<strong>我们需要添加两个环境变量，修改一个环境变量</strong>，如下所示：</p>
<ol>
<li>新增变量 <code>JAVA_HOME</code>， 变量值为 <code>C:\Program Files\Java\jdk1.8.0_201</code>（你的 jdk 安装路径）;</li>
<li>新增变量 <code>CLASSPATH</code>, 变量值为 <code>.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</code></li>
<li>修改变量<code>Path</code>, 在此变量值的最后加上<code>%JAVA_HOME%\bin;</code></li>
</ol>
<p>配置完成后打开终端输入<code>javac</code>,看见如下提示即安装成功：</p>
<p><img src="https://img-blog.csdnimg.cn/2019032817355618.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p class="node-title">2.2 安装 nodejs 和 npm</p>

<p>到官网下载安装包后按指示安装即可，参照<code>Karma</code>安装文档里安装即可。</p>
<p class="node-title">2.3 配置 cnpm</p>

<p>打开终端，输入如下指令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https:<span class="comment">//registry.npm.taobao.org</span></span><br></pre></td></tr></table></figure></p>
<p>完成后输入以下命令测试<code>cnpm</code>是否安装成功：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm -v</span><br></pre></td></tr></table></figure></p>
<h2 id="三-搭建-UI-recorder"><a href="#三-搭建-UI-recorder" class="headerlink" title="三.搭建 UI recorder"></a><strong>三.搭建 <code>UI recorder</code></strong></h2><p>我们需要按顺序进行以下步骤（考虑到以后阅读人员的时间跨度问题，如果遇到某些包报版本警告，在 <code>packagejson</code> 中把此包的版本号删除后再执行<code>cnpm install -D</code>即可）</p>
<ol>
<li>全局安装 <code>uirecorder</code> 和 <code>mocha</code>。</li>
<li>安装相关包依赖。</li>
<li>初始化 <code>uirecorder</code> 文件夹。（此处有坑，需注意）</li>
<li>对远程服务器中的网站进行录制并生成测试脚本。</li>
<li>下载 <code>chromedriver</code>，并将<code>chromedriver.exe</code>放到指定的位置。（需要和你的<code>chrome</code>版本对应）</li>
<li>下载 <code>Selenium Server</code>。</li>
<li>安装 <code>webDriver</code> 以及生成测试报告的包依赖。</li>
</ol>
<p>下面我们一步步来讲这6个步骤。</p>
<p class="node-title">3.1 全局安装 uirecorder 和 mocha</p>

<p>首先，新建一个文件夹，本文以如下文件夹为例：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328174932806.PNG" alt="在这里插入图片描述"></p>
<p>打开<code>gitbash</code>，cd 到此文件夹目录下，初始化<code>packagejson</code>文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm init -y</span><br></pre></td></tr></table></figure></p>
<p>然后执行以下代码全局安装包：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install uirecorder mocha -g</span><br></pre></td></tr></table></figure></p>
<p>如下所示：</p>
<p><img src="https://img-blog.csdnimg.cn/201903281749400.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>安装完成后我们可以输入<code>uirecorder -V</code>来查看是否安装成功：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328174951676.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p class="node-title">3.2 安装相关包依赖</p>

<p>执行以下命令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install jwebdriver expect.js mocha-generators faker --save-dev</span><br></pre></td></tr></table></figure></p>
<p>如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328174958115.PNG" alt="在这里插入图片描述"></p>
<p class="node-title">3.3 初始化 uirecorder 文件夹</p>

<p>在<code>git bash</code> 中输入以下指令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uirecorder init</span><br></pre></td></tr></table></figure></p>
<p>然后按照命令提示进行配置。这儿要提醒大家的是，本文中进行的是基础配置，诸位肯定会有特殊需求，可以根据需要自行配置。如果没有特殊要求，则可以按照下面的基础配置来操作：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175007692.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>简单解释下上面那些命令各自的含义，见下图：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175021635.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>配置完成后会在<code>/ui-recorder-standard</code>下出现以下文件结构：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175027959.PNG" alt="在这里插入图片描述"></p>
<p>到这我们的准备环节算是顺利成功了，下一步就要开始录制环节了。</p>
<p class="node-title">3.4 录制并生成脚本</p>

<p>在<code>gitbash</code>中执行以下命令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uirecorder start sample/test.spec.js</span><br></pre></td></tr></table></figure></p>
<p>则会出现交互式命令配置需要你选择，无特殊需求可按下图来配置：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175035642.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>完成后会弹出两个浏览器，一个是给你操作交互的浏览器A，一个是自动录制的浏览器B，我们主要是操作浏览器A：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175046696.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>本文以 Web 部内部的控制中心举例，远程访问 ip 为 <code>192.168.10.36:7002</code> 机器上的控制中心，点击<strong>开始录制</strong>后开始进行操作，触发各种交互事件：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175055552.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>可以看到我们进行的每一步操作，在短暂的延时后都会得到及时的反馈，在右下角弹窗出来。</p>
<p>操作完成后点击<strong>结束录制</strong>即可，此时已经在根目录下生成了<code>/sample</code>文件夹和<code>test.spac.js</code>测试用例文件。</p>
<p>需要注意的是，理论上你也可以直接修改这个测试用例文件，但是这需要一定的<code>nodejs</code>基础，如果你对此并不熟练，我不建议你修改此文件，以免后面的录制回放阶段出现无法预知的错误。</p>
<p class="node-title">3.5 下载 chromedriver，并将 chromedriver.exe 放到指定的位置</p>

<p>从 3.5 之后这几步的作用主要是启动 <code>webDriver</code> 服务以支撑 <code>uirecorder</code> 进行自动化的录制回放和生成测试报告。这几步相对比较繁琐，我尽量用简洁的语言和图片补充的形式避免大家踩坑。</p>
<p>我们首先要下载 <code>chromedriver</code> 压缩文件。提供一个<a href="https://npm.taobao.org/mirrors/chromedriver" target="_blank" rel="noopener">chromedriver淘宝镜像地址</a>。</p>
<p>打开后我们会发现有很多版本，这里要注意，必须要下载和你的<code>chrome</code>对应的驱动才行。</p>
<p>打开<code>chrome</code>查看版本号:</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175106700.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后按照这个对照表来下载对应的驱动：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175116120.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>如果以上对应表不适用于你的 <code>chrome</code> 浏览器，你也可以自行 google 或者升级浏览器版本。</p>
<p>下载下来后是一个压缩包，把解压出来的 <code>chromedriver.exe</code> 文件放到你的 <code>chrome</code> 安装目录下：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175122555.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>还没完，最后你需要把此目录加到系统环境变量<code>Path</code>变量值的最后：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175131672.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>此步目的是要让 <code>SeleniumServer</code> 能够直接通过文件名找到对应的 <code>driver</code>。</p>
<p class="node-title">3.6 下载 Selenium Server</p>

<p>点击 <a href="https://selenium-release.storage.googleapis.com/index.html" target="_blank" rel="noopener">Selenium Server</a> 下载最新版即可。下载完成后会得到一个<code>selenium-server-standalone-3.9.1.jar</code>的文件，把它放入 <code>/ui-recorder-standard</code> 目录下：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175139339.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p class="node-title">3.7 安装 <code>webDriver</code> 以及生成测试报告的包依赖</p>

<p>打开 <code>gitbash</code> 并执行以下命令：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnpm install selenium-standalone -g</span><br><span class="line">cnpm install mochawesome chai resemblejs-node -D</span><br></pre></td></tr></table></figure></p>
<h2 id="四-录制回放及生成测试报告"><a href="#四-录制回放及生成测试报告" class="headerlink" title="四.录制回放及生成测试报告"></a><strong>四.录制回放及生成测试报告</strong></h2><p>我们按以下步骤顺序进行：</p>
<ol>
<li>启动 <code>Selenium Server</code>。</li>
<li>执行回放命令，查看报告。</li>
</ol>
<p class="node-title">4.1 启动 Selenium Server</p>

<p>在 <code>/ui-recorder-standard</code> 目录下新开一个 <code>gitbash</code> 终端，执行以下命令开启 <code>Selenium Server</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar selenium-server-standalone<span class="number">-3.9</span><span class="number">.1</span>.jar</span><br></pre></td></tr></table></figure></p>
<p>但是如果你已经开启了一个默认是 4444 端口的<code>server</code>，执行这一步就会提示你以下异常：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175147542.PNG" alt="在这里插入图片描述"></p>
<p>这时我们根据提示使用指定端口的命令即可：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar selenium-server-standalone<span class="number">-3.9</span><span class="number">.1</span>.jar -port <span class="number">4002</span></span><br></pre></td></tr></table></figure></p>
<p>成功后如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175153140.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p class="node-title">4.2 执行回放命令，查看报告</p>

<p>打开<code>git bash</code>执行以下命令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha sample/test.spec.js --reporter mochawesome</span><br></pre></td></tr></table></figure></p>
<p>等待终端执行完毕后，可以看到根目录下生成了<code>/mochawesome-report</code>文件夹，文件夹内包含测试报告。</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175159477.PNG" alt="在这里插入图片描述"></p>
<p>测试报告如下图：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328175205605.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/05/26/UI recorder 自动化UI测试框架使用手册/" data-id="cjtviqeqg0013uovdye6nxifn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端自动化/">前端自动化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-原生JS实现并封装前端路由" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/20/原生JS实现并封装前端路由/" class="article-date">
  <time datetime="2018-05-20T10:08:21.000Z" itemprop="datePublished">2018-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/20/原生JS实现并封装前端路由/">原生 JavaScript 实现并封装前端路由</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>目前，前端中所有的MVVM框架中基本都有自己的Router组件，比如React-router或者Vue-router,主要的作用就是通过拦截url来返回相应的组件。如果我们通过原生js来实现一个类似的router，应该怎么做呢？本文将提供一个思路和完整demo，以解释其中的原理。</p>
<h2 id="一-效果图"><a href="#一-效果图" class="headerlink" title="一.效果图"></a>一.效果图</h2><p><img src="https://img-blog.csdnimg.cn/20181220162938372.gif" alt="在这里插入图片描述"></p>
<h2 id="二-代码示例"><a href="#二-代码示例" class="headerlink" title="二.代码示例"></a>二.代码示例</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"author"</span> content=<span class="string">"helang.love@qq.com"</span>&gt;</span><br><span class="line">    &lt;title&gt;前端路由&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;style type="text/</span>css<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        .router_box,</span></span><br><span class="line"><span class="string">        #router-view &#123;</span></span><br><span class="line"><span class="string">            padding: 0 20px;</span></span><br><span class="line"><span class="string">            background-color: gainsboro;</span></span><br><span class="line"><span class="string">            height: 55px;</span></span><br><span class="line"><span class="string">            line-height: 50px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .router_box&gt;a &#123;</span></span><br><span class="line"><span class="string">            padding: 0 10px;</span></span><br><span class="line"><span class="string">            color: #364086;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .content&#123;</span></span><br><span class="line"><span class="string">            border: 1px solid #a030b3;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class="</span>router_box<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;a href="</span>/home<span class="string">" class="</span>router<span class="string">"&gt;主页&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;a href="</span>/sort<span class="string">" class="</span>router<span class="string">"&gt;分类&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;a href="</span>/image<span class="string">" class="</span>router<span class="string">"&gt;图片&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;a href="</span>/own<span class="string">" class="</span>router<span class="string">"&gt;我的&lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class="</span>content<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;iframe name="</span>mainiframe<span class="string">" src="</span><span class="string">" id="</span>mainiframe<span class="string">" scrolling="</span>no<span class="string">" onload="</span><span class="string">" frameborder="</span><span class="number">0</span><span class="string">" width="</span><span class="number">100</span>%<span class="string">"&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script type="</span>text/javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        (function (win, undefined) &#123;</span></span><br><span class="line"><span class="string">            function Router(parames) &#123;</span></span><br><span class="line"><span class="string">                if (!(this instanceof Router)) &#123;</span></span><br><span class="line"><span class="string">                    return new Router(arguments)</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                let router = &#123;&#125;;</span></span><br><span class="line"><span class="string">                router.routes = parames.routes || [];</span></span><br><span class="line"><span class="string">                router.target = parames.target || "</span><span class="string">";</span></span><br><span class="line"><span class="string">                router.index = parames.index || "</span><span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                this.loadIndex(router);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                document.querySelectorAll("</span>.router<span class="string">").forEach((item, index) =&gt; &#123;</span></span><br><span class="line"><span class="string">                    item.addEventListener("</span>click<span class="string">", function (e) &#123;</span></span><br><span class="line"><span class="string">                        let event = e || win.event;</span></span><br><span class="line"><span class="string">                        event.preventDefault();</span></span><br><span class="line"><span class="string">                        win.location.href = `#$&#123;this.getAttribute("</span>href<span class="string">")&#125;`;</span></span><br><span class="line"><span class="string">                    &#125;, false);</span></span><br><span class="line"><span class="string">                &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                win.addEventListener("</span>hashchange<span class="string">", function () &#123;</span></span><br><span class="line"><span class="string">                    this.routerLoad(router);</span></span><br><span class="line"><span class="string">                &#125;.bind(this));</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Router.prototype = &#123;</span></span><br><span class="line"><span class="string">                routerLoad:  router =&gt; &#123;</span></span><br><span class="line"><span class="string">                    let nowHash = win.location.hash;</span></span><br><span class="line"><span class="string">                    let index = router.routes.findIndex((item, index) =&gt; &#123;</span></span><br><span class="line"><span class="string">                        return nowHash == ('#' + item.path);</span></span><br><span class="line"><span class="string">                    &#125;);</span></span><br><span class="line"><span class="string">                    document.querySelector(`$&#123;router.target&#125;`).src = router.routes[index].component;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                loadIndex:  router =&gt; &#123;</span></span><br><span class="line"><span class="string">                    document.querySelector(`$&#123;router.target&#125;`).src = router.index;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            win.Router = Router;</span></span><br><span class="line"><span class="string">        &#125;)(window, undefined)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        new Router(&#123;</span></span><br><span class="line"><span class="string">            target: '#mainiframe',</span></span><br><span class="line"><span class="string">            index: '/static/templates/home.html',</span></span><br><span class="line"><span class="string">            routes: [&#123;</span></span><br><span class="line"><span class="string">                    path: '/home',</span></span><br><span class="line"><span class="string">                    component: '/static/templates/home.html'</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    path: '/sort',</span></span><br><span class="line"><span class="string">                    component: '/static/templates/sort.html'</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    path: '/image',</span></span><br><span class="line"><span class="string">                    component: '/static/templates/image.html'</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    path: '/own',</span></span><br><span class="line"><span class="string">                    component: '/static/templates/own.html'</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务端(nodejs+express)：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">let</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/static'</span>,express.static(path.join(<span class="string">'public'</span>)));</span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.sendFile(__dirname +<span class="string">'/index.html'</span>)   </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/router'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.sendFile(__dirname +<span class="string">'/router.html'</span>)   </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">2000</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="三-代码分析"><a href="#三-代码分析" class="headerlink" title="三.代码分析"></a>三.代码分析</h2><p>我先讲讲实现个路由需要从哪几方面入手。</p>
<p><strong>第一步：监听a标签，并给href里的url加锚</strong><br>我们知道，一般情况下菜单栏的加载模式中，都是通过<code>&lt;a&gt;</code>中的<code>href=&#39;/xxxx&#39;</code>来跳转到指定的页面，所以路由的第一步就是监听到此菜单栏中<code>&lt;a href=&#39;/xxx&#39;&gt;</code>的点击事件，并在点击时通过<code>event.preventDefault()</code>阻止浏览器的默认行为。阻止默认行为后，咱们就可以通过<code>#/index</code>这种形式给拿到的url加锚，至于为什么要加锚，第二步中会说明。</p>
<p><strong>第二步：监听hashchange事件，并在监听被触发时加载对应的页面</strong><br>在第一步中我们给url加上了锚，目的就是通过<code>hashchange</code>函数来监听加了锚之后的url（即hash）,监听到hash的变化后，我们可以拿到点击时的url，通过调用<code>Router(params)</code>时传入的<code>params</code>参数来找到此文件的静态路径，然后传入到iframe 的 src中。</p>
<p>注意：在这个例子中我使用的<code>iframe</code>来替代<code>组件</code>，在实际业务情景中，你当然也可以将这个iframe换成一个主容器（<code>&lt;div class=&quot;content&quot;&gt;&lt;/div&gt;</code>之类的），然后在’component’属性中传入组件的具体内容，或者文件路径，都是可以的。</p>
<p><strong>第三步：在Router调用时添加目标容器，添加首页加载</strong><br>因为我在这个例子中使用的内容容器是个iframe，所以我需要考虑多个iframe嵌套下的Loader目标(target)问题，当然，首页也是需要可以设置默认加载的。<br>所以，在new Roter()时我们可以看到这两个参数：<br><img src="https://img-blog.csdnimg.cn/20181220170419287.png" alt="在这里插入图片描述"></p>
<h2 id="四-注意事项"><a href="#四-注意事项" class="headerlink" title="四.注意事项"></a>四.注意事项</h2><p>1.这段代码的意义是将函数内this环境绑定到函数内，而不是window。<br><img src="https://img-blog.csdnimg.cn/20181220172204567.png" alt="在这里插入图片描述"><br>当然，你也可以这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br></pre></td></tr></table></figure></p>
<p>2.要注意箭头函数中this的指向(箭头函数没有自己的this)<br>3.如果想把这个demo完整的跑起来，需要安装node环境，然后<code>npm install express</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/05/20/原生JS实现并封装前端路由/" data-id="cjtvizvfi001guovd137wk5m4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Karma 自动化测试框架搭建文档" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/19/Karma 自动化测试框架搭建文档/" class="article-date">
  <time datetime="2018-05-19T12:45:37.000Z" itemprop="datePublished">2018-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/19/Karma 自动化测试框架搭建文档/">Karma 自动化测试框架搭建文档</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a><strong>一.前言</strong></h2><p>此文档为前端自动化单元测试框架 <code>Karma</code> 的搭建以及使用文档。</p>
<h2 id="二-准备环境"><a href="#二-准备环境" class="headerlink" title="二.准备环境"></a><strong>二.准备环境</strong></h2><p>先列出我们此次搭建测试框架 <code>Karma</code> 必须的环境和包。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> node.js (node 引擎)</span><br><span class="line"><span class="number">2.</span> npm (node 包管理器)</span><br><span class="line"><span class="number">3.</span> cnpm(可选) (淘宝镜像)</span><br><span class="line"><span class="number">4.</span> karma (提供 web 服务和浏览器适配)</span><br><span class="line"><span class="number">5.</span> mocha   (单元测试框架)</span><br><span class="line"><span class="number">6.</span> chai    (断言库)</span><br><span class="line"><span class="number">6.</span> requirejs    (提供非commonjs规范的模块加载)</span><br><span class="line"><span class="number">7.</span> karma-mocha karma-chai   karma-requirejs  (karma 中对应的包)</span><br><span class="line"><span class="number">8.</span> karma-chrome-launcher  karma-ie-launcher  (karma 中的浏览器适配包)</span><br><span class="line"><span class="number">9.</span> karma-mocha-reporter (karma 中的 mocha 终端测试报告)</span><br><span class="line"><span class="number">10.</span> karma-htmlfile-reporter (karam 生成 html 格式的测试报告文件)</span><br></pre></td></tr></table></figure></p>
<h2 id="三-安装步骤"><a href="#三-安装步骤" class="headerlink" title="三.安装步骤"></a><strong>三.安装步骤</strong></h2><p><strong>1. 安装 <code>node</code> 和 <code>npm</code></strong></p>
<p>进入<a href="http://nodejs.cn/download/" target="_blank" rel="noopener">node官网</a>，根据你的操作系统选择对应的安装包。安装时记得添加选择默认添加环境变量和安装<code>npm</code>。</p>
<p>安装完成后打开<code>gitbash</code>输入以下命令测试是否安装成功：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ node -v</span><br><span class="line">v10<span class="number">.14</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">$ npm -v</span><br><span class="line"><span class="number">6.4</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2. 安装 <code>cnpm</code></strong></p>
<p>此为<code>npm</code>的淘宝镜像，为了解决<code>npm</code>下载包网速过慢的问题。请在<code>gitbash</code>中输入以下命令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https:<span class="comment">//registry.npm.taobao.org</span></span><br></pre></td></tr></table></figure></p>
<p>完成后输入以下命令测试<code>cnpm</code>是否安装成功：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm -v</span><br></pre></td></tr></table></figure></p>
<p><strong>3.初始化 <code>package.json</code></strong></p>
<p>首先，在项目内新建一个文件夹 <code>/test</code>。(与<code>static</code>,<code>templates</code>平级)。此时我们有以下目录结构：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173037465.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>由于这是我已经配置好的目录结构，各位可以先不用关心细节，我们从空的<code>/test</code>文件夹开始。</p>
<p>在 <code>gitbash</code> 中进入 <code>/test</code> 目录，然后输入命令:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm init -y</span><br></pre></td></tr></table></figure></p>
<p>会出现一个名为 <code>package.json</code> 的 <code>json</code> 文件，文件内容如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173102843.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>4. 安装 <code>karma</code> 和 <code>karma-cli</code></strong></p>
<p>什么是 <code>karma</code> 这种问题大家可以自行去<a href="http://karma-runner.github.io/latest/index.html" target="_blank" rel="noopener">Karma官网</a>自行查看。</p>
<p>我们回到刚刚那个 <code>gitbash</code> 目录，输入以下命令：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cnpm install karma-cli -g</span><br><span class="line">$ cnpm install karma -D</span><br></pre></td></tr></table></figure></p>
<p>安装好之后输入 <code>karma --version</code> 来查看是否安装成功。</p>
<p><strong>5.安装 <code>package.json</code> 中的依赖</strong></p>
<p>打开你的 <code>package.json</code> 文件，此时它的内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"test"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"keywords"</span>: [],</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"karma"</span>: <span class="string">"^4.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>devDependencies</code> 中是你的依赖包，现在你要做的就是用下面这个 <code>json</code> 中的内容去替换你的 <code>package.json</code> 内容。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"test-project2"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"keywords"</span>: [],</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"chai"</span>: <span class="string">"^4.2.0"</span>,</span><br><span class="line">    <span class="string">"karma"</span>: <span class="string">"^4.0.0"</span>,</span><br><span class="line">    <span class="string">"karma-chai"</span>: <span class="string">"^0.1.0"</span>,</span><br><span class="line">    <span class="string">"karma-chrome-launcher"</span>: <span class="string">"^2.2.0"</span>,</span><br><span class="line">    <span class="string">"karma-htmlfile-reporter"</span>: <span class="string">"^0.3.7"</span>,</span><br><span class="line">    <span class="string">"karma-ie-launcher"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="string">"karma-mocha"</span>: <span class="string">"^1.3.0"</span>,</span><br><span class="line">    <span class="string">"karma-mocha-reporter"</span>: <span class="string">"^2.2.5"</span>,</span><br><span class="line">    <span class="string">"karma-requirejs"</span>: <span class="string">"^1.1.0"</span>,</span><br><span class="line">    <span class="string">"mocha"</span>: <span class="string">"^5.2.0"</span>,</span><br><span class="line">    <span class="string">"requirejs"</span>: <span class="string">"^2.3.6"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>替换完了后，回到 <code>gitbash</code> 中输入:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cnpm install</span><br></pre></td></tr></table></figure></p>
<p>安装完成后即可。</p>
<p><strong>5.初始化 <code>karma.conf.js</code> 配置文件</strong></p>
<p>现在我们需要配置一下 <code>karma</code> 的配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ karma init</span><br></pre></td></tr></table></figure></p>
<p>然后 <code>karma</code> 会让我们配置一些选项，你可以按下面这张图来配：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173146189.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>完成后我们可以在 <code>/test</code> 文件夹根目录里看到一个 <code>karma.conf.js</code> 文件。</p>
<p>注意，在 <code>windows</code>操作系统下使用 <code>gitbash</code> 进行 <code>karma init</code> 时会报以下错误：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173224177.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这时你切换到 <code>windows</code> 的默认终端来执行命令就好。</p>
<p>由于不同的项目文件目录的配置不同，所以提供一个标准的 <code>karma.conf.js</code> 配置不是一件现实的事情，它需要对 <code>karma.conf.js</code> 文件中的 <code>files</code> 属性进行一些改变。下面我提供一个控制中心 <code>RC2</code> 版本的 <code>karma.conf.js</code> 配置：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Karma configuration</span></span><br><span class="line"><span class="comment">// Generated on Mon Jan 28 2019 14:56:31 GMT+0800 (GMT+08:00)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// base path that will be used to resolve all patterns (eg. files, exclude)</span></span><br><span class="line">    basePath: <span class="string">''</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// frameworks to use</span></span><br><span class="line">    <span class="comment">// available frameworks: https://npmjs.org/browse/keyword/karma-adapter</span></span><br><span class="line">    frameworks: [<span class="string">'mocha'</span>, <span class="string">'requirejs'</span>, <span class="string">'chai'</span>],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to load in the browser</span></span><br><span class="line">    files: [</span><br><span class="line">      &#123; <span class="attr">pattern</span>: <span class="string">'lib/*.js'</span>,  <span class="attr">included</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">pattern</span>: <span class="string">'../static/js/common/*.js'</span>,  <span class="attr">included</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">pattern</span>: <span class="string">'unit-test/**/*.spec.js'</span>, <span class="attr">included</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="string">'./test-main.js'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to exclude</span></span><br><span class="line">    exclude: [</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preprocess matching files before serving them to the browser</span></span><br><span class="line">    <span class="comment">// available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor</span></span><br><span class="line">    preprocessors: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// test results reporter to use</span></span><br><span class="line">    <span class="comment">// possible values: 'dots', 'progress'</span></span><br><span class="line">    <span class="comment">// available reporters: https://npmjs.org/browse/keyword/karma-reporter</span></span><br><span class="line">    reporters: [<span class="string">'mocha'</span>, <span class="string">'html'</span>],</span><br><span class="line"></span><br><span class="line">    mochaReporter: &#123;</span><br><span class="line">      output: <span class="string">'autowatch'</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    htmlReporter: &#123;</span><br><span class="line">      outputFile: <span class="string">'reproter/units.html'</span>,</span><br><span class="line">            </span><br><span class="line">      <span class="comment">// Optional</span></span><br><span class="line">      pageTitle: <span class="string">'Unit Tests'</span>,</span><br><span class="line">      subPageTitle: <span class="string">'A sample project description'</span>,</span><br><span class="line">      groupSuites: <span class="literal">true</span>,</span><br><span class="line">      useCompactStyle: <span class="literal">true</span>,</span><br><span class="line">      useLegacyStyle: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// web server port</span></span><br><span class="line">    port: <span class="number">9877</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable colors in the output (reporters and logs)</span></span><br><span class="line">    colors: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// level of logging</span></span><br><span class="line">    <span class="comment">// possible values: config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG</span></span><br><span class="line">    logLevel: config.LOG_INFO,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable watching file and executing tests whenever any file changes</span></span><br><span class="line">    autoWatch: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// start these browsers</span></span><br><span class="line">    <span class="comment">// available browser launchers: https://npmjs.org/browse/keyword/karma-launcher</span></span><br><span class="line">    browsers: [<span class="string">'Chrome'</span>,  <span class="string">'IE'</span>],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Continuous Integration mode</span></span><br><span class="line">    <span class="comment">// if true, Karma captures browsers, runs the tests and exits</span></span><br><span class="line">    singleRun: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Concurrency level</span></span><br><span class="line">    <span class="comment">// how many browser should be started simultaneous</span></span><br><span class="line">    concurrency: <span class="literal">Infinity</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>6.设置 <code>requirejs</code> 入口文件</strong></p>
<p>通常来说我们需要在 <code>A.js</code> 中引入 <code>B.js</code> 中的一个函数，需要这样：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="built_in">require</span>(<span class="string">'./B.js'</span>);</span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>)  <span class="comment">// logs 3</span></span><br></pre></td></tr></table></figure></p>
<p><code>B.js</code>中的内容应该如下：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exports.add = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++)&#123;</span><br><span class="line">        sum += <span class="built_in">arguments</span>[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体规则大家可以自行去查阅<code>commonJS规范</code>。</p>
<p>但是我们现在不具备这个条件，前端代码并不是<code>commonjs</code> 格式，所以我们需要引入<code>requirejs</code> 来解决这个问题。</p>
<p>在 <code>/test</code> 文件夹下新建 <code>test-main.js</code> 文件，内容如下：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TEST_REGEXP = <span class="regexp">/(spec|test)\.js$/i</span>;</span><br><span class="line"><span class="keyword">var</span> allTestFiles = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a list of all the test files to include</span></span><br><span class="line"><span class="built_in">Object</span>.keys(<span class="built_in">window</span>.__karma__.files).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (TEST_REGEXP.test(file)) &#123;</span><br><span class="line">    <span class="comment">// Normalize paths to RequireJS module names.</span></span><br><span class="line">    <span class="comment">// If you require sub-dependencies of test files to be loaded as-is (requiring file extension)</span></span><br><span class="line">    <span class="comment">// then do not normalize the paths</span></span><br><span class="line">    <span class="keyword">var</span> normalizedTestModule = file.replace(<span class="regexp">/^\/base\/|\.js$/g</span>, <span class="string">''</span>);</span><br><span class="line">    allTestFiles.push(normalizedTestModule);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">  <span class="comment">// Karma serves files under /base, which is the basePath from your config file</span></span><br><span class="line">  baseUrl: <span class="string">'/base'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// example of using a couple of path translations (paths), to allow us to refer to different library dependencies, without using relative paths</span></span><br><span class="line">  paths: &#123;</span><br><span class="line">   </span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// example of using a shim, to load non AMD libraries (such as underscore)</span></span><br><span class="line">  shim: &#123;</span><br><span class="line">    <span class="string">'underscore'</span>: &#123;</span><br><span class="line">      exports: <span class="string">'_'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dynamically load all test files</span></span><br><span class="line">  deps: allTestFiles,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we have to kickoff jasmine, as it is asynchronous</span></span><br><span class="line">  callback: <span class="built_in">window</span>.__karma__.start</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><strong>7.进行简单的 unit test</strong></p>
<p>我以控制中心<code>RC2</code>的目录结构为例，在 <code>/webui/static/js/common</code>下有个<code>datahandle.js</code>文件，我们取其中的一个<code>dataHandle.cutLargeNum()</code>函数来进行测试。</p>
<p>首先看下目前 <code>/test</code> 的目录结构：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173236872.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><code>/reporter</code>是生成测试报告的文件夹，这个在后面再说。</p>
<p>注意这个 <code>/unit-test</code> 文件夹，这个文件夹名字并非是固定的，只要你能把它和 <code>karma.conf.js</code> 中 <code>files</code> 的路径名称对应起来。</p>
<p>我们在 <code>/unit-test</code> 文件夹下创建 <code>index.spec.js</code>文件，<strong>注意，以后此文件夹下所有的测试用例文件都应该以 `</strong>.spec.js<code>结尾，应该我们在</code>karma.conf.js<code>和</code>test-main.js` 文件中都做了正则限制。**</p>
<p><code>index.spec.js</code> 文件内容如下：<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expect = chai.expect;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'unit test'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    it(<span class="string">'dataHandle.cutLargeNum(1000) = 1.00万'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        expect(dataHandle.cutLargeNum(<span class="number">10000</span>)).to.equal(<span class="string">'1.00万'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>chai</code>为断言库，文中使用的是 <code>BDD</code> 风格的 <code>expect</code> 断言。<br>我们在 <code>gitbash</code> 中输入 <code>$ karma start</code> 运行测试，有以下输出结果：</p>
<p><img src="https://img-blog.csdnimg.cn/2019032817324444.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们还可以修改 <code>karma.conf.js</code> 中的 <code>singleRun</code> 属性为 <code>false</code>：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Continuous Integration mode</span></span><br><span class="line"><span class="comment">// if true, Karma captures browsers, runs the tests and exits</span></span><br><span class="line">  singleRun: <span class="literal">false</span>,</span><br></pre></td></tr></table></figure></p>
<p>然后再运行 <code>$ karma start</code>,此时你再修改 <code>/static/js/common</code> 下的任何一个 js 文件， <code>karma</code> 都会自动重新运行 <code>/unit-test</code> 下的测试用例。</p>
<p><strong>8.生成测试报告</strong></p>
<p>生成测试报告的模块我选择的是 <code>karma-htmlfile-reporter</code>,相应需要做的配置我已经加在之前的 <code>karma.conf.js</code> 文件中了。</p>
<p>我们只需要执行 <code>$ karma start --reporter html</code> ，就可以发现 <code>/test</code> 目录多了一个 <code>/reporter</code> 文件夹，里面放着我们的测试报告 <code>units.html</code>。</p>
<p>大概长这样：</p>
<p><img src="https://img-blog.csdnimg.cn/20190328173255173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/05/19/Karma 自动化测试框架搭建文档/" data-id="cjtvipe0y0010uovdjik97nzt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端自动化/">前端自动化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JavaScript事件委托机制与this的比较" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/06/JavaScript事件委托机制与this的比较/" class="article-date">
  <time datetime="2018-04-06T14:23:45.000Z" itemprop="datePublished">2018-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/06/JavaScript事件委托机制与this的比较/">JavaScript事件委托机制与this的比较</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>很多时候我们在完成交互时，页面的一些dom结构是根据后台传输过来的数据动态加载的，如果说我们需要给这些数量比较大的dom结构（比如说表格，或则ul&gt;li）添加click或则hover事件时，手写/遍历生成元素内的onclick函数式不可取的，会大量的消耗浏览器内存，降低程序的性能。所以，采用事件委托机制或this就来替代就显得很有必要了。</p>
<h2 id="一-什么是事件委托机制"><a href="#一-什么是事件委托机制" class="headerlink" title="一.什么是事件委托机制"></a>一.什么是事件委托机制</h2><p>简单来说，就是借助event事件对象和事件触发的冒泡流程来完成事件委托机制。冒泡流程顾名思义，当你点击某个元素时，事件捕捉会从它的父级往上查找，一直到domcument为止。而event事件对象则是委托机制的重点所在，借助它，我们可以做到定点触发，指哪打哪。<br>举个例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button id=<span class="string">"addBtn"</span>&gt;添加&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;ul id="owenUl"&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;111&lt;/</span>li&gt;</span><br><span class="line">    &lt;li&gt;<span class="number">222</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;333&lt;/</span>li&gt;</span><br><span class="line">&lt;<span class="regexp">/ul&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我们想给ul中的不同的li的添加点击事件，普通写法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $li = $(<span class="string">'#owenUl'</span>).children();</span><br><span class="line"><span class="keyword">var</span> len = $li.length;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>; i&lt;= len<span class="number">-1</span>;i++)&#123;</span><br><span class="line">   $($li[i]).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">      alert(<span class="keyword">this</span>.innerHTML)</span><br><span class="line">   &#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此思路想必大家都经历过：先获取父级元素的所有子元素，然后在遍历子元素时添加点击事件。它的缺点我不再多说。</p>
<p>下面是事件委托写法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#owenUl'</span>).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//获取event和target兼容ie的写法</span></span><br><span class="line">    <span class="keyword">var</span> ev = event || <span class="built_in">window</span>.event;</span><br><span class="line">　　<span class="keyword">var</span> target = ev.target || ev.srcElement;</span><br><span class="line">　　<span class="comment">//获取点击节点的元素类型名</span></span><br><span class="line">    <span class="keyword">if</span>(target.nodeName.toLowerCase() == <span class="string">"li"</span>)&#123;</span><br><span class="line">      <span class="comment">//此时的target就是&lt;li&gt;dom元素</span></span><br><span class="line">      alert(target.innerHTML)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)；</span><br><span class="line"></span><br><span class="line">$(<span class="string">'#addBtn'</span>).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> str = <span class="string">'&lt;li&gt;123456&lt;/li&gt;'</span>;</span><br><span class="line">   $(<span class="string">'#owenUl'</span>).append(str);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>对于已存在的dom结构事件委托可以正常添加事件，那么对于用户操作后增加的dom呢？答案是也可以。<br><img src="https://img-blog.csdn.net/20180910112449944?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<h2 id="二-事件委托与this的比较"><a href="#二-事件委托与this的比较" class="headerlink" title="二.事件委托与this的比较"></a>二.事件委托与this的比较</h2><p>关于javascript的this,在什么情况下指向什么，严格模式和非严格模式的下this的区别在哪，还有this可以通过哪些函数改变指向，以及在箭头函数中this的指向等等这一系列问题，在本篇中暂不概述，有兴趣的话可以点击下面的链接看看我写的另一篇关于tihs指向问题的探究：<br><a href="https://blog.csdn.net/dk2290/article/details/82587118" target="_blank" rel="noopener">javascript this探究</a></p>
<p>我们在本篇中只谈谈用this改写的事件绑定与事件委托改写的事件绑定有何区别：<br>假如有以下dom结构：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button id=<span class="string">"addBtn"</span>&gt;添加&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;ul id="owenUl"&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;111&lt;/</span>li&gt;</span><br><span class="line">    &lt;li&gt;<span class="number">222</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;333&lt;/</span>li&gt;</span><br><span class="line">&lt;<span class="regexp">/ul&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我们进行以下改写：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#owenUl li'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       alert(<span class="keyword">this</span>.innerHTML);</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure></p>
<p>相比较，是不是比事件委托代码量还少？逻辑还简单？事件委托能起到的效果，它一样可以，在一些相对较复杂的业务需求下，它能使的代码复杂度更低：<br>假如我们有以下dom结构：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;button id=<span class="string">"addBtn"</span>&gt;添加&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">   &lt;ul id="owenUl"&gt;</span></span><br><span class="line"><span class="regexp">       &lt;li&gt;</span></span><br><span class="line"><span class="regexp">           &lt;span&gt;1111&lt;/</span>span&gt;</span><br><span class="line">       &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">       &lt;li&gt;</span></span><br><span class="line"><span class="regexp">           &lt;span&gt;2222&lt;/</span>span&gt;</span><br><span class="line">       &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">       &lt;li&gt;</span></span><br><span class="line"><span class="regexp">           &lt;span&gt;3333&lt;/</span>span&gt;</span><br><span class="line">       &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">   &lt;/u</span>l&gt;</span><br></pre></td></tr></table></figure></p>
<p>整个dom的css如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ul li &#123;</span><br><span class="line">        width: <span class="number">49</span>px;</span><br><span class="line">        height: <span class="number">30</span>px;</span><br><span class="line">        border: <span class="number">1</span>px solid gray;</span><br><span class="line">        margin-bottom: <span class="number">10</span>px;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p>实际效果如图：<br><img src="https://img-blog.csdn.net/201809101124065?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>现在我们有以下业务需求：<br>1.点击li里的区域时，要能显示span的内容。<br>2.点击不同的li显示各自span的内容。</p>
<p>如果是使用事件委托，我们可以这么写:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#owenUl'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//获取event和target兼容ie的写法</span></span><br><span class="line">    <span class="keyword">var</span> ev = event || <span class="built_in">window</span>.event;</span><br><span class="line">    <span class="keyword">var</span> target = ev.target || ev.srcElement;</span><br><span class="line">    <span class="keyword">var</span> text;</span><br><span class="line">    <span class="keyword">switch</span> (target.nodeName.toLowerCase()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"li"</span>:</span><br><span class="line">           <span class="keyword">var</span> spanDom = target.children[<span class="number">0</span>];</span><br><span class="line">           text = spanDom.innerHTML;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'li'</span>)</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"span"</span>:</span><br><span class="line">           text = target.innerHTML;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'span'</span>)</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>　　事件委托的机制的问题在于，当你在判断<code>target.nodeName.toLowerCase() == &#39;li&#39;</code>的逻辑里去做业务时，你点击li中的span元素是得不到任务反应的，也就是说在此判断中，点击里面的span时，<code>console.log(&#39;li&#39;)</code>这一块的代码并不会被触发，因此代码的复杂度就高了。<br>　　下面我们看用this来改写是什么样子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#owenUl li'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> spanDom = <span class="keyword">this</span>.children[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">console</span>.log(spanDom.innerHTML);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>很惊讶对吧，就两行代码。只要你在写代码前捋清了业务逻辑。用this改写代码的复杂度大大降低，也减少了维护成本。</p>
<p>综上，我个人是比较喜欢用this来进行事件绑定的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/04/06/JavaScript事件委托机制与this的比较/" data-id="cjtvibbaz000duovd3rzs6kda" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JavaScript 闭包机制的详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/04/JavaScript 闭包机制的详解/" class="article-date">
  <time datetime="2018-04-04T13:04:03.000Z" itemprop="datePublished">2018-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/04/JavaScript 闭包机制的详解/">JavaScript 闭包机制的详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>JavaScript 的闭包是老生常谈的问题了，包括面试时也喜欢问，所以是时候总结一波了。</p>
<p>在我看来，解决一个碰到的问题有两个思路：<strong>一是找到解决这个问题的方法就OK。二是尝试从根源上去解析这个问题，以避免被其他类似的问题困扰。</strong></p>
<h2 id="一-什么是闭包？"><a href="#一-什么是闭包？" class="headerlink" title="一.什么是闭包？"></a>一.什么是闭包？</h2><p>闭包是什么？我们先看看 MDN 上对它的解释：</p>
<blockquote>
<p><strong>闭包是函数和声明该函数的词法环境的组合。</strong></p>
</blockquote>
<p>MDN上的官方说明都比较言简意赅，解释的比较经典，也许有些伙计可能会有些迷糊，所以我简单给大家翻译下上面那句话什么意思：</p>
<p><strong>1.“闭包一定与函数有关，没有函数就没有闭包”。<br>2.“闭包不仅仅只有函数，还包括函数的执行上下文”。</strong></p>
<p>单纯的理论太干巴巴了，咱们看点实际的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aa</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> bb = <span class="string">'This is a Test'</span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">cc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(bb)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dd = aa();</span><br><span class="line">dd();  <span class="comment">// logs 'This is a Test'</span></span><br></pre></td></tr></table></figure></p>
<p>上面这个函数，就是一个基础的闭包，我们可以看到，在函数 aa( ) 中有一个 函数内变量 bb 和一个函数内函数 cc( )，cc( )函数中引用了aa( ) 作用域内的 bb 变量，然后被 aa 的作用域返回，暴露给了 window 环境。</p>
<p>这么一个简单的闭包，<strong>我们可以简单归纳出闭包三个特性中的前两个：</strong></p>
<p><strong>1.闭包一定是函数内嵌套函数。<br>2.闭包可以让我们在函数外部访问函数内部的私有变量和私有函数。</strong></p>
<p>OK,我们再来看一个例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aa</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">cc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="built_in">console</span>.log(count)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dd = aa();</span><br><span class="line">dd(); <span class="comment">// logs 1</span></span><br><span class="line">dd(); <span class="comment">// logs 2</span></span><br><span class="line">dd(); <span class="comment">// logs 3</span></span><br></pre></td></tr></table></figure></p>
<p>那么它使用起来与普通函数有什么区别呢？我们进行一个对比就清楚了：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aa_normal</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">cc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="built_in">console</span>.log(count)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cc();</span><br><span class="line">&#125;</span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br></pre></td></tr></table></figure></p>
<p>我们还可以更大胆，更奔放一些：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aa_normal</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">	count++;</span><br><span class="line">	<span class="built_in">console</span>.log(count)</span><br><span class="line">&#125;</span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br><span class="line">aa_normal();  <span class="comment">// logs 1</span></span><br></pre></td></tr></table></figure></p>
<p>这下是不是对比就很鲜明了？根据 JavaScript 的 GC 机制，普通的函数在每一次调用结束时，都会被内存回收，所以普通函数无论你执行多少次，那个 count 都只会是1，你问我为什么？因为你永远叫不醒一个装睡的人嘛。而对于闭包来说就不一样了，它会一直留在内存中，除非你手动清除它。</p>
<p>so~我们得出了闭包三个特性中的最后一个特性：<br><strong>3.带有闭包的词法环境中的变量和函数不会被GC机制回收。</strong></p>
<p>okok~我们现在总结性的看一下闭包的总的三条特性：</p>
<p><strong>1.闭包一定是函数内嵌套函数。<br>2.闭包可以让我们在函数外部访问函数内部的私有变量和私有函数。<br>3.带有闭包的词法环境中的变量和函数不会被GC机制回收。</strong></p>
<h2 id="二-循环中的闭包"><a href="#二-循环中的闭包" class="headerlink" title="二.循环中的闭包"></a>二.循环中的闭包</h2><p>闭包其实还有很多其他高级的用法，比如说以下列表：</p>
<ol>
<li>结果缓存</li>
<li>封装</li>
<li>实现类和继承</li>
</ol>
<p>但是这些并不是我们这篇文章的重点。本文的重点是啥？是解决刚需！什么叫刚需，就是你跟你女朋友擦枪走火，她怀孕你们得结婚了，<strong>房子</strong>就是刚需了。那么闭包对于大家来说什么情况下是刚需？<strong>那就是闭包出问题的时候</strong>是刚需！所以本文重点就是探讨，什么情况下它会出问题，以及怎么解决它。</p>
<p>下面我说说第一种思路。<br>咱们先看一个业务中常见的需求：<strong>后台给一个类数组，里面都是对象，你拿到这个数据后要在一个 ul 中生成相应的 li 列表，并给对应的 li 添加点击事件。我们来看代码：</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"ie=edge"</span>&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;ul <span class="class"><span class="keyword">class</span></span>=<span class="string">"data-list"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> data = [&#123;<span class="attr">name</span>:<span class="string">'aaa'</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">'bbb'</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">'ccc'</span>&#125;];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initDom</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i= <span class="number">0</span>;i&lt; data.length ;i++)&#123;</span><br><span class="line">    		<span class="keyword">var</span> p = i;</span><br><span class="line">            <span class="keyword">var</span> ulDom = <span class="built_in">document</span>.querySelector(<span class="string">'.data-list'</span>);</span><br><span class="line">            <span class="keyword">var</span> liDom = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">            <span class="keyword">var</span> text = <span class="built_in">document</span>.createTextNode(data[i].name);</span><br><span class="line">            liDom.className = <span class="string">'li'</span> + i;</span><br><span class="line">            liDom.appendChild(text);</span><br><span class="line">            ulDom.appendChild(liDom)</span><br><span class="line">        	<span class="built_in">document</span>.querySelector(<span class="string">'.data-list .li'</span>+i).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				alert(data[p].name);</span><br><span class="line">			&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">initDom();</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>正常情况下，我们想要的结果自然是点击aaa，弹出aaa，点击bbb，弹出bbb；但是事实上却是无论单击谁，弹出的都是ccc。原因就在于闭包了。在 initDom( )这个函数中，我们给 li 绑定了点击事件，所以说，其实是有三个闭包，每次循环都有一个，如果这三个闭包都有各自的作用域链，那大家相安无事，自然也不会出现这种情况；但是现在是循环结束了，点击事件还未触发，这就会造成三个闭包公用一个父级作用域链，此时循环已经结束，p都是2；</p>
<p>那么我们怎么解决这个问题呢？有三种方式：<br><strong>第一种：立即执行函数</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [&#123;<span class="attr">name</span>:<span class="string">'aaa'</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">'bbb'</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">'ccc'</span>&#125;];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initDom</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i= <span class="number">0</span>;i&lt; data.length ;i++)&#123;</span><br><span class="line">      (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> ulDom = <span class="built_in">document</span>.querySelector(<span class="string">'.data-list'</span>);</span><br><span class="line">                <span class="keyword">var</span> liDom = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">                <span class="keyword">var</span> text = <span class="built_in">document</span>.createTextNode(data[i].name);</span><br><span class="line">                liDom.className = <span class="string">'li'</span> + i;</span><br><span class="line">                liDom.appendChild(text);</span><br><span class="line">                ulDom.appendChild(liDom)</span><br><span class="line">                <span class="keyword">var</span> p = i;</span><br><span class="line">                <span class="built_in">document</span>.querySelector(<span class="string">'.data-list .li'</span> + i).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    alert(data[p].name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line">initDom();</span><br></pre></td></tr></table></figure></p>
<p>这时我们再去点击对应的 li，就能弹出对应的name了。</p>
<p><strong>第二种：工厂函数</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showMsg</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">     alert(msg)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alertMsg</span>(<span class="params">msg</span>) </span>&#123; </span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">      showMsg(msg)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initDom</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = [&#123;</span><br><span class="line">       name: <span class="string">'aaa'</span></span><br><span class="line">       &#125;, &#123;</span><br><span class="line">       name: <span class="string">'bbb'</span></span><br><span class="line">       &#125;, &#123;</span><br><span class="line">       name: <span class="string">'ccc'</span></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">          <span class="keyword">var</span> item = data[i];</span><br><span class="line">          <span class="keyword">var</span> ulDom = <span class="built_in">document</span>.querySelector(<span class="string">'.data-list'</span>);</span><br><span class="line">          <span class="keyword">var</span> liDom = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">          <span class="keyword">var</span> text = <span class="built_in">document</span>.createTextNode(data[i].name);</span><br><span class="line">          liDom.className = <span class="string">'li'</span> + i;</span><br><span class="line">          liDom.appendChild(text);</span><br><span class="line">          ulDom.appendChild(liDom)    </span><br><span class="line">          <span class="built_in">document</span>.querySelector(<span class="string">'.data-list .li'</span> + i).onclick = alertMsg(item.name)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">initDom();</span><br></pre></td></tr></table></figure></p>
<p>这种工厂模式，其实与我之前在总结闭包的第三个特性时举的例子很相似，它的重点在于<code>document.querySelector(&#39;.data-list .li&#39; + i).onclick = alertMsg(item.name)</code>这一行代码，实际上它的作用就是创建了循环次数个的工厂函数实例，同过实例化来使每一个闭包的作用域的互干扰，最终达到目的；</p>
<p><strong>第三种：ES6 中的 let</strong><br>过多的闭包会占用大量的内存，特别是你存储的数据还比较大的时候，更会影响性能。所以如果你处于ES 2015 的环境，你可以尝试使用 let，它使得每一个块级作用域都有自己的作用域，简单粗暴解决问题。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initDom</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> data = [&#123;</span><br><span class="line">          name: <span class="string">'aaa'</span></span><br><span class="line">          &#125;, &#123;</span><br><span class="line">          name: <span class="string">'bbb'</span></span><br><span class="line">          &#125;, &#123;</span><br><span class="line">         name: <span class="string">'ccc'</span></span><br><span class="line">     &#125;];</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;  </span><br><span class="line">            <span class="keyword">var</span> ulDom = <span class="built_in">document</span>.querySelector(<span class="string">'.data-list'</span>);</span><br><span class="line">            <span class="keyword">var</span> liDom = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">            <span class="keyword">var</span> text = <span class="built_in">document</span>.createTextNode(data[i].name);</span><br><span class="line">            liDom.className = <span class="string">'li'</span> + i;</span><br><span class="line">            liDom.appendChild(text);</span><br><span class="line">            ulDom.appendChild(liDom)</span><br><span class="line">            <span class="built_in">document</span>.querySelector(<span class="string">'.data-list .li'</span> + i).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                alert(data[i].name);</span><br><span class="line">            &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="三-闭包以外的世界"><a href="#三-闭包以外的世界" class="headerlink" title="三.闭包以外的世界"></a>三.闭包以外的世界</h2><p>从上面的知识点我们可以发现，想更深入的使用闭包，我们还需要了解 JavaScript 以下内容：</p>
<ol>
<li>变量作用域链</li>
<li>JavaScript 的内存回收机制</li>
</ol>
<p><strong>什么是作用域链？</strong></p>
<p><strong>简单来说，就是当函数在一个环境中执行时，会创建变量对象的一个作用域链。作用域链的用途是保证对执行环境有权访问的所有变量和函数的有序访问</strong>。何为有序？比如说有三个for循环，他们在各自的循环里都定义了一个局部变量，假设从外到内是a,b,c。对于最里面的那层循环来说，它的作用域链就是  c到b到a到全局变量。</p>
<p><strong>什么是内存回收机制？</strong></p>
<p>和 java 一样 JavaScrip t也是自动回收机制，把不再使用的内存回收。什么情况下不再使用呢?比如说在一个函数中定义的局部变量，在这个函数执行完毕后它就被销毁了。但是当你在一个函数中定义了另一个匿名函数，并在里面定义了一个局部变量，在这个匿名函数外部又调用了这个内部的局部变量，这时回收机制就不会生效，直到这个闭包彻底失效。</p>
<p>有趣的是，在我遇到这个问题不就后我又碰到一个类似的情况，那就是settimeout( )函数。使用场景是，处于某种需要，我想将一个for循环遍历的时间缩短，然后直接在for中加入了settimeout后发现打印的是乱码，这与之前的闭包问题有异曲同工之妙。</p>
<p>为什么会这样呢？因为js是单线程的执行顺序，而settimeout()却是一个异步的方法。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];  </span><br><span class="line"><span class="keyword">var</span> len=a.length;  </span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)&#123;  </span><br><span class="line">    setTimeout&#123;<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">       <span class="built_in">console</span>.log(i);  </span><br><span class="line">    &#125;,<span class="number">100</span>&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会打印3个undefined。但是修改一下代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> len = a.length;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(i);</span><br><span class="line">        &#125;, i * <span class="number">100</span>)</span><br><span class="line">    &#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就可以正确的log出来了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/04/04/JavaScript 闭包机制的详解/" data-id="cjtvilu9m000xuovdumoipj9y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前后端分离下的前端架构选型" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/03/前后端分离下的前端架构选型/" class="article-date">
  <time datetime="2018-04-03T15:21:04.000Z" itemprop="datePublished">2018-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/03/前后端分离下的前端架构选型/">前后端分离下的前端架构选型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-主要目标"><a href="#一-主要目标" class="headerlink" title="一.主要目标"></a>一.主要目标</h2><p>1.<strong>前后端解耦</strong>。前端主要任务是将原有页面中的大量的<code>Python Flask</code>框架里的<code>jinja2</code>模板内容给替换，采用纯粹的<code>JavaScript</code>模板引擎来进行解耦。<br>2.<strong>前后端分离</strong>。前端拥有自己的静态资源服务器和路由，负责静态文件的转发和<code>html</code>页面的返回。</p>
<h2 id="二-几种技术选型方案"><a href="#二-几种技术选型方案" class="headerlink" title="二.几种技术选型方案"></a>二.几种技术选型方案</h2><p>选型方案，将从重构成本，人员成本(即学习成本)，部署难度等几方面考虑。</p>
<p><strong>方案一</strong>： <a href="http://aui.github.io/art-template/" target="_blank" rel="noopener">art-template（用于html文件解耦）</a> + <a href="http://www.expressjs.com.cn/" target="_blank" rel="noopener">node.js(express)(用于静态资源返回 + 前端路由)</a> + <a href="http://mockjs.com/" target="_blank" rel="noopener">Mock.js（用于模拟伪后端数据）</a>   </p>
<p>方案优缺点：<br>1.<code>art-template</code>。由腾讯出品，github 有人维护，API 详细，插件相关生态也还不错，利于快速上手，重构成本相对较低。但是此模板引擎的模板继承功能必须由 node 服务提供，所以前端中间层只能是 node，强耦合。</p>
<ol start="2">
<li><code>node.js(express)</code>。node + express 提供前端的本地服务和路由层，学习成本不高，利于快速上手。但是不适合初级前端工程师来维护，另外，部署项目是，合并前后端资源时也是个需要处理的问题，因为需要将 node 引擎打进包里。<br>3.<code>mock.js</code>，不论什么技术方案，mockjs 都能极大地提高前端的开发效率，它让前端不再需要等待后台接口开发完毕，只要拿到 RESTful API 接口，前端可以自己按数据格式模拟数据，与后端并行开发。</li>
</ol>
<hr>
<p><strong>方案二</strong>：<a href="http://aui.github.io/art-template/" target="_blank" rel="noopener">art-template（用于html文件解耦）</a> + Nginx（用于静态资源返回） + 前端路由拦截器（类似vue-router,需要自己造轮子） + <a href="http://mockjs.com/" target="_blank" rel="noopener">Mock.js（用于模拟伪后端数据）</a>   </p>
<p><strong>方案优点</strong>：<br>1.最大限度的减少其他库的引入，降低了重构的成本<br>2.最大限度的降低了部署的难度。</p>
<p><strong>方案缺点</strong>：<br>1.缺点是部分关键功能需要自己实现，踩坑，填坑的过程必不可少，当然，研发同样能得到锻炼。<br>2.<code>art-template</code>中的模板继承功能由于是非 node 提供服务所以使用不了，需要前端自己实现。</p>
<hr>
<p><strong>方案三:</strong><br><a href="https://markojs.com/" target="_blank" rel="noopener">marko.js（用于解耦html文件）</a> +  Nginx（用于静态资源返回） + 前端路由拦截器（类似vue-router,需要自己造轮子） + <a href="http://mockjs.com/" target="_blank" rel="noopener">Mock.js（用于模拟伪后端数据）</a>   </p>
<p><strong>方案优点：</strong><br>1.最大限度的减少其他库的引入，降低了重构的成本<br>2.最大限度的降低了部署的难度。<br>3.<code>marko.js</code>自带 SSI 的 shtml 模板继承功能。<br><strong>方案缺点</strong>：<br>1.缺点是路由拦截器需要自己实现，踩坑，填坑的过程必不可少，当然，研发同样能得到锻炼。<br>2.<code>marko.js</code>为 ebay 研发，现已开源。但是社区生态不太好，活跃度低；库过于庞大，其实我们只需要使用它的模板继承功能。</p>
<p><strong>方案四:</strong><br><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">vue.js</a>（解耦） + <a href="http://mockjs.com/" target="_blank" rel="noopener">Mock.js（用于模拟伪后端数据）</a><br><strong>方案优点：</strong><br>1.重构思路清晰，此法案使用的人很多，可以避免踩一些坑。<br>2.VUE生态健壮，各种方案极多，避免重复造轮子。<br>3.降低了部署的难度。<br><strong>方案缺点：</strong><br>1.重构成本高，对前端来说基本属于重写项目。<br>2.vue为spa单页应用，对于复杂的项目来说前端的复杂性会提高。<br>3.有一点学习成本，需要前端具备一定的 ES6，webpack，babel 的基础。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/04/03/前后端分离下的前端架构选型/" data-id="cjtvibbcp000juovds15hu7tq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/框架/">框架</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-D3.js制作带悬浮提示框的渐变色中国地图（使用node.js提供服务）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/03/D3.js制作带悬浮提示框的渐变色中国地图（使用node.js提供服务）/" class="article-date">
  <time datetime="2018-04-03T09:20:05.000Z" itemprop="datePublished">2018-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/03/D3.js制作带悬浮提示框的渐变色中国地图（使用node.js提供服务）/">D3.js 制作带悬浮提示框的渐变色中国地图（使用node.js提供服务）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-效果图"><a href="#一-效果图" class="headerlink" title="一.效果图"></a>一.效果图</h2><p><img src="https://img-blog.csdnimg.cn/20181109165627595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>  <strong>使用D3来制作中国地图主要有几个地方需要注意：</strong></p>
<ol>
<li>需要用到投影函数，并挂在在路径生成器上。</li>
<li>由于同源策略限制的原因，需要通过服务器来返回地图文件，比如<code>china.json</code>这种。</li>
<li>如果需要做渐变色渲染或者显示标注，需要额外的数据，并通过服务器返回。</li>
<li>要区分开<code>topojson</code>和<code>geojson</code>两种格式的数据的不同，他们的加载模式也有所不同，相对于<code>geojson</code>数据，<code>topojson</code>文件更小，渲染时更节省Dom空间。</li>
</ol>
<h2 id="二-代码示例"><a href="#二-代码示例" class="headerlink" title="二.代码示例"></a>二.代码示例</h2><p><strong>我把代码部分分为前端和后端，咱们先看前端的部分。</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"ie=edge"</span>&gt;</span><br><span class="line">    &lt;title&gt;topojsonMAP&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;style&gt;</span></span><br><span class="line"><span class="regexp">        /</span>* Tooltip CSS *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">        .d3-tip &#123;</span></span><br><span class="line"><span class="regexp">            line-height: 1.5;</span></span><br><span class="line"><span class="regexp">            font-weight: 400;</span></span><br><span class="line"><span class="regexp">            font-family: "avenir next", Arial, sans-serif;</span></span><br><span class="line"><span class="regexp">            padding: 6px;</span></span><br><span class="line"><span class="regexp">            background: rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="regexp">            color: #FFA500;</span></span><br><span class="line"><span class="regexp">            border-radius: 1px;</span></span><br><span class="line"><span class="regexp">            pointer-events: none;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span>* Creates a small triangle extender <span class="keyword">for</span> the tooltip *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">        .d3-tip:after &#123;</span></span><br><span class="line"><span class="regexp">            box-sizing: border-box;</span></span><br><span class="line"><span class="regexp">            display: inline;</span></span><br><span class="line"><span class="regexp">            font-size: 8px;</span></span><br><span class="line"><span class="regexp">            width: 100%;</span></span><br><span class="line"><span class="regexp">            line-height: 1.5;</span></span><br><span class="line"><span class="regexp">            color: rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="regexp">            position: absolute;</span></span><br><span class="line"><span class="regexp">            pointer-events: none;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      </span></span><br><span class="line"><span class="regexp">        .d3-tip.n:after &#123;</span></span><br><span class="line"><span class="regexp">            content: "\25BC";</span></span><br><span class="line"><span class="regexp">            margin: -1px 0 0 0;</span></span><br><span class="line"><span class="regexp">            top: 100%;</span></span><br><span class="line"><span class="regexp">            left: 0;</span></span><br><span class="line"><span class="regexp">            text-align: center;</span></span><br><span class="line"><span class="regexp">        &#125;       </span></span><br><span class="line"><span class="regexp">    &lt;/</span>style&gt;</span><br><span class="line">&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="/</span><span class="keyword">static</span>/js/d3-v4.js<span class="string">"&gt;&lt;/script&gt;  </span></span><br><span class="line"><span class="string">&lt;script src="</span>/<span class="keyword">static</span>/js/topojson.js<span class="string">"&gt;&lt;/script&gt;  &lt;!-- 用来处理topojson格式的地图文件 --&gt;</span></span><br><span class="line"><span class="string">&lt;script src="</span>/<span class="keyword">static</span>/js/d3-tip.js<span class="string">"&gt;&lt;/script&gt;	&lt;!-- 用来生成tip提示框 --&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">    const width = 1200;</span></span><br><span class="line"><span class="string">    const height = 1000;</span></span><br><span class="line"><span class="string">    var svg = d3.select("</span>body<span class="string">")</span></span><br><span class="line"><span class="string">        .append("</span>svg<span class="string">")</span></span><br><span class="line"><span class="string">        .attr("</span>width<span class="string">", width)</span></span><br><span class="line"><span class="string">        .attr("</span>height<span class="string">", height)</span></span><br><span class="line"><span class="string">        .append("</span>g<span class="string">");</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var tip = d3.tip()</span></span><br><span class="line"><span class="string">        .attr('class', 'd3-tip')</span></span><br><span class="line"><span class="string">        .offset([-10, 0])</span></span><br><span class="line"><span class="string">        .html((d) =&gt; &#123;</span></span><br><span class="line"><span class="string">            return "</span>&lt;strong&gt;Country: &lt;/strong&gt;&lt;span class='details'&gt;" + d.properties.name + "&lt;br&gt;&lt;/span&gt;"</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    //创建投影函数</span><br><span class="line">    var projection = d3.geoMercator()</span><br><span class="line">        .center([107, 31])</span><br><span class="line">        .scale(950)</span><br><span class="line">        .translate([width / 2, height / 2 + height / 8])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //创建地理路径生成器</span><br><span class="line">    var path = d3.geoPath()</span><br><span class="line">        .projection(projection);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    svg.call(tip);</span><br><span class="line">    //读取json文件并创建地图</span><br><span class="line">    d3.json("/static/china.topojson", (error, topoRoot) =&gt; &#123;</span><br><span class="line">        if (error)</span><br><span class="line">            return console.error(error);</span><br><span class="line"></span><br><span class="line">        //将TopoJSON对象转换成GeoJSON，保存在georoot中</span><br><span class="line">        var geoRoot = topojson.feature(topoRoot, topoRoot.objects.china);</span><br><span class="line">        //输出GeoJSON对象</span><br><span class="line">        console.log('geoRoot', geoRoot);</span><br><span class="line"></span><br><span class="line">        //添加中国各种的路径元素</span><br><span class="line">        var provinces = svg.append("g")</span><br><span class="line">            .attr("class", "countries")</span><br><span class="line">            .selectAll("path")</span><br><span class="line">            .data(geoRoot.features)</span><br><span class="line">            .enter()</span><br><span class="line">            .append("path")</span><br><span class="line">            .attr("class", "province")</span><br><span class="line">            .style("fill", "#ccc")</span><br><span class="line">            .attr("d", path)</span><br><span class="line">            .on("mouseover", (d) =&gt; &#123;</span><br><span class="line">                tip.show(d);</span><br><span class="line">                d3.select(this)</span><br><span class="line">                    .style("opacity", 0.8)</span><br><span class="line">            &#125;)</span><br><span class="line">            .on("mouseout", (d) =&gt; &#123;</span><br><span class="line">                tip.hide(d);</span><br><span class="line">                d3.select(this)</span><br><span class="line">                    .style("opacity", 1)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        var $ = &#123;</span><br><span class="line">            ajax: (url) =&gt; &#123;</span><br><span class="line">                var request = new XMLHttpRequest();</span><br><span class="line">                request.open('get', url);</span><br><span class="line">                request.send();</span><br><span class="line">                request.onreadystatechange = () =&gt; &#123;</span><br><span class="line">                    if (request.readyState === 4 &amp;&amp; request.status === 200) &#123;</span><br><span class="line">                        var json = JSON.parse(request.responseText);</span><br><span class="line">                        //将读取到的数据存到数组values，令其索引号为各省的名称</span><br><span class="line">                        var cityArr = [];</span><br><span class="line">                        for (var i = 0; i &lt; json.provinces.length; i++) &#123;</span><br><span class="line">                            var name = json.provinces[i].name;</span><br><span class="line">                            var value = json.provinces[i].value;</span><br><span class="line">                            cityArr[name] = value;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        //求最大值和最小值</span><br><span class="line">                        var maxvalue = d3.max(json.provinces, function (d) &#123;</span><br><span class="line">                            return d.value;</span><br><span class="line">                        &#125;);</span><br><span class="line">                        var minvalue = 0;</span><br><span class="line"></span><br><span class="line">                        //定义一个线性比例尺，将最小值和最大值之间的值映射到[0, 1]</span><br><span class="line">                        var linear = d3.scaleLinear()</span><br><span class="line">                            .domain([minvalue, maxvalue])</span><br><span class="line">                            .range([0, 1]);</span><br><span class="line"></span><br><span class="line">                        //创建颜色插值函数</span><br><span class="line">                         var colorFunc = d3.interpolate("#395988", "#4D8DC3");</span><br><span class="line"></span><br><span class="line">                        //设定各省份的填充色</span><br><span class="line">                        provinces.style("fill", function (d, i) &#123;</span><br><span class="line">                            var t = linear(cityArr[d.properties.name]);</span><br><span class="line">                            var color = colorFunc(t);</span><br><span class="line">                            return color.toString();</span><br><span class="line">                        &#125;)                </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax('/stats/data');</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>我在上述代码中已经添加了很清晰的注释，但是需要注意的仍然有几点：</strong></p>
<ol>
<li><p><code>d3-tip.js</code>这个文件大家在github上下载的时候，如果使用最新版本的话以上代码是会报错的，如果你严格按照github上这个项目作者所提示的一样去引用，不好意思，还是会报错，但是你如果换成2013这个版本就可以运行起来，如下图版本：<br><img src="https://img-blog.csdnimg.cn/20181109163526848.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
<li><p><code>d3.json()</code>这个高阶函数并不是必须要使用的。你们可以在上面看到，我用原生js封装了一个ajax函数<code>$.ajax()</code>用来处理get请求，也能得到相应数据,当然，你如果通过服务器获取数据，记住要将它格式化成json格式的数据。</p>
</li>
<li><code>TopoJSON</code>是<code>GeoJSON</code> 按拓扑学编码后的扩展形式，是由 D3 的作者 Mike Bostock 制定的。相比 <code>GeoJSON</code>直接使用 Polygon、Point 之类的几何体来表示图形的方法，<code>TopoJSON</code>中的每一个几何体都是通过将共享边（被称为arcs）整合后组成的。<code>TopoJSON</code>消除了冗余，文件大小缩小了 80%，因为：1.边界线只记录一次（例如广西和广东的交界线只记录一次)2.地理坐标使用整数，不使用浮点数。</li>
</ol>
<p><strong>下面我们看看后端部分，后端由node.js提供服务器。</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*返回静态资源 public是我存放静态资源的文件夹，static是我准备返回静态资源的url*/</span></span><br><span class="line">app.use(<span class="string">'/static'</span>, express.static(path.join(<span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/map/faster'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.render(<span class="string">'map_faster'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/stats/data'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"中国"</span>,</span><br><span class="line">        <span class="string">"provinces"</span>: [&#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"北京"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">14149</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"天津"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">2226.41</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"河北"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1544.94</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"山西"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">3720.24</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"内蒙古"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">2771.96</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"辽宁"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">6263.69</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"吉林"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">4494.77</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"黑龙江"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">3835.48</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"上海"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">5493.23</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"江苏"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">12299.72</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"浙江"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">14151.74</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"安徽"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1562.67</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"福建"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">14225.67</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"江西"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">384.73</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"山东"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">9923.65</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"河南"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1611.41</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"湖北"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1202.97</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"湖南"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">928.36</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"广东"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">15610.67</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"广西"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">9278.87</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"海南"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">13348.02</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"重庆"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1168.32</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"四川"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">7798.15</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"贵州"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">168.94</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"云南"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">8947.08</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"西藏"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">13405.7</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"陕西"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">1597.47</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"甘肃"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">4522.35</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"青海"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">5424.32</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"宁夏"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">545.45</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"新疆"</span>,</span><br><span class="line">                <span class="string">"value"</span>: <span class="number">13150.57</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(data);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="string">'7002'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Start with port: '</span> + port);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>至此，整个绘制就完成了。如果大家有疑问，欢迎在底下留言。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/04/03/D3.js制作带悬浮提示框的渐变色中国地图（使用node.js提供服务）/" data-id="cjtvibbah000cuovdl490md26" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/D3-js/">D3.js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JavaScript 数组去重的7种实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/02/JavaScript 数组去重的7种实现/" class="article-date">
  <time datetime="2018-04-02T04:24:24.000Z" itemprop="datePublished">2018-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/02/JavaScript 数组去重的7种实现/">JavaScript 数组去重的7种实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h2><p>js中数组去重是老生常谈的问题，之所以是老生常谈，是因为这东西在平常的业务场景中挺常见的，是刚需；其次在面试中面试者也喜欢问，基本上是希望你能回答的越多越好，今天趁这个机会我正好捋一捋思路，把这块整理一下。</p>
<p>要说在前面的是，不同的业务场景决定不同的技术手段，也不存在一招通吃的函数或者算法。而且，大家一定不要被‘优雅’这两个字所桎梏，在业务中，能解决问题的办法，就是好办法；能解决问题的办法才有资格去优化性能和写法，变的更优雅。所以，初期面临问题的时候，我们先考虑的一定是怎么解决它，而不是一步想出一个既兼顾性能又兼顾写法的处理办法。</p>
<hr>
<h2 id="二-双重遍历"><a href="#二-双重遍历" class="headerlink" title="二.双重遍历"></a>二.双重遍历</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temp = [];</span><br><span class="line">    <span class="keyword">let</span> len = <span class="keyword">this</span>.length;</span><br><span class="line">    <span class="keyword">let</span> flag;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = i + <span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>[j] === <span class="keyword">this</span>[i]) &#123;</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            temp.push(<span class="keyword">this</span>[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> result = [<span class="number">1</span>,<span class="number">1</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'result'</span>, result);</span><br><span class="line"><span class="comment">// 输出 [ 1, '1', 0, '0', undefined, null, NaN, NaN, &#123;&#125;, &#123;&#125;, [], [], /a/, /a/ ]</span></span><br></pre></td></tr></table></figure>
<p>双重遍历可以说是什么语言都通吃的去重方法了，也应该是很容易一开始就产生的思路。<br>从上面的输出我们可以看出，除了对NaN和对象，双重遍历完成了去重，在普通的业务场景下我们用它也可以完成需求。</p>
<h2 id="三-单重循环"><a href="#三-单重循环" class="headerlink" title="三.单重循环"></a>三.单重循环</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="keyword">let</span> len = <span class="keyword">this</span>.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(arr.indexOf(<span class="keyword">this</span>[i]) == <span class="number">-1</span>)&#123;</span><br><span class="line">              arr.push(<span class="keyword">this</span>[i])  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> result = [<span class="number">1</span>,<span class="number">1</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'result'</span>, result);</span><br><span class="line"><span class="comment">// 输出 [ 1, '1', 0, '0', undefined, null, NaN, NaN, &#123;&#125;, &#123;&#125;, [], [], /a/, /a/ ]</span></span><br></pre></td></tr></table></figure>
<p>单重循环其实就是建立在双重循环之上的优化方案，其实思路很简单，无非就是利用一个函数内的空数组去接收去过重的数组里的元素，判断依据就是通过元数组内的元素的下标去与这个空数组内未来会添加的元素下标做对比。</p>
<h2 id="四-排序后去重"><a href="#四-排序后去重" class="headerlink" title="四.排序后去重"></a>四.排序后去重</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="comment">//对原数组cancat()的意义在于其会返回一个新数组,排序后而不会修改原来的数组结构</span></span><br><span class="line">    <span class="keyword">let</span> sortArr = <span class="keyword">this</span>.concat().sort();  </span><br><span class="line">    <span class="keyword">let</span> len = sortArr.length;</span><br><span class="line">    <span class="keyword">let</span> temp = sortArr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((!i || temp !== sortArr[i])) &#123;</span><br><span class="line">            arr.push(sortArr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        temp = sortArr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> result = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>].unique();  普通重复数组去重是没问题的</span><br><span class="line"><span class="keyword">let</span> result2 = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique(); </span><br><span class="line"><span class="built_in">console</span>.log(result)</span><br><span class="line"><span class="comment">// [ 0, '0', 1, '1' ]</span></span><br><span class="line"><span class="built_in">console</span>.log(result2)</span><br><span class="line"><span class="comment">//输出不正确，不仅仅NaN和对象类型没有去重，还有部分普通元素如'1'之类的也没有去重，根本问题在于sort()函数没有按照预期的目标去工作.</span></span><br></pre></td></tr></table></figure>
<p>我们可以看出，排序后去重这一思路局限性比较多，元数据中在掺杂了如[],{},NaN之类的元素后并不能将相同的元素按相邻的原则排列在一起，主要还是受限于Array.sort()函数。所以我本人是不推荐你使用的。</p>
<h2 id="五-对象Key去重"><a href="#五-对象Key去重" class="headerlink" title="五.对象Key去重"></a>五.对象Key去重</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">let</span> rec = [];</span><br><span class="line">    <span class="keyword">let</span> len = <span class="keyword">this</span>.length;</span><br><span class="line">    <span class="keyword">let</span> temp = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; len;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!temp[<span class="keyword">this</span>[i]])&#123;</span><br><span class="line">            temp[<span class="keyword">this</span>[i]] = <span class="number">1</span>;</span><br><span class="line">            rec.push(<span class="keyword">this</span>[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rec;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">let</span> result = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique()</span><br><span class="line"><span class="built_in">console</span>.log(result)  <span class="comment">//[ 1, 0, undefined, null, NaN, &#123;&#125;, [], /a/ ]</span></span><br></pre></td></tr></table></figure>
<p>从输出我们可以看出，字符串的元素被去除了，但是实际上’1’和1明显不是一个东西，所以我们应该加一个类型判断的标识符：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">let</span> rec = [];</span><br><span class="line">    <span class="keyword">let</span> len = <span class="keyword">this</span>.length;</span><br><span class="line">    <span class="keyword">let</span> temp = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; len;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> key = <span class="keyword">typeof</span> <span class="keyword">this</span>[i] + <span class="keyword">this</span>[i];</span><br><span class="line">        <span class="keyword">if</span>(!temp[key])&#123;</span><br><span class="line">            temp[key] = <span class="number">1</span>;</span><br><span class="line">            rec.push(<span class="keyword">this</span>[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rec;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">let</span> result = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique()</span><br><span class="line"><span class="built_in">console</span>.log(result)  <span class="comment">// [ 1, '1', 0, '0', undefined, null, NaN, &#123;&#125;, [], /a/ ]</span></span><br></pre></td></tr></table></figure></p>
<p>此时，从输出的结果来看，这种优化后的利用key来去重的思路完美解决了需求。</p>
<h2 id="六-ES6-Map-去重"><a href="#六-ES6-Map-去重" class="headerlink" title="六.ES6 Map 去重"></a>六.ES6 Map 去重</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">let</span> rec = [];</span><br><span class="line">    <span class="keyword">let</span> len = <span class="keyword">this</span>.length;</span><br><span class="line">    <span class="keyword">let</span> temp = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; len;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!temp.get(<span class="keyword">this</span>[i]))&#123;</span><br><span class="line">            temp.set(<span class="keyword">this</span>[i], <span class="number">1</span>);</span><br><span class="line">            rec.push(<span class="keyword">this</span>[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rec;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">let</span> result = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique()</span><br><span class="line"> <span class="built_in">console</span>.log(result);</span><br><span class="line"> <span class="comment">// [ 1, '1', 0, '0', undefined, null, NaN, &#123;&#125;, &#123;&#125;, [], [], /a/, /a/ ]</span></span><br></pre></td></tr></table></figure>
<p>从输出我们可以看出，对象不去重，其他去重。</p>
<h2 id="七-ES6-Set-去重"><a href="#七-ES6-Set-去重" class="headerlink" title="七.ES6 Set 去重"></a>七.ES6 Set 去重</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> [...new <span class="built_in">Set</span>(<span class="keyword">this</span>)]</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">let</span> result = [<span class="number">1</span>, <span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">NaN</span>,<span class="literal">NaN</span>,&#123;&#125;,&#123;&#125;,[],[],/a/,/a/].unique()</span><br><span class="line"> <span class="built_in">console</span>.log(result) </span><br><span class="line"> <span class="comment">// [ 1, '1', 0, '0', undefined, null, NaN, &#123;&#125;, &#123;&#125;, [], [], /a/, /a/ ]</span></span><br></pre></td></tr></table></figure>
<p>从输出我们可以看出，对象不去重，其他去重，代码极其简单，就一行。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/04/02/JavaScript 数组去重的7种实现/" data-id="cjtvibbaf000buovdv0071unl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-D3.js创建力导向图(V4)附带详细的参数说明" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/30/D3.js创建力导向图(V4)附带详细的参数说明/" class="article-date">
  <time datetime="2018-03-30T12:51:14.000Z" itemprop="datePublished">2018-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/30/D3.js创建力导向图(V4)附带详细的参数说明/">D3.js创建力导向图(V4)附带详细的参数说明</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-效果展示"><a href="#一-效果展示" class="headerlink" title="一.效果展示"></a>一.效果展示</h2><p><img src="https://img-blog.csdnimg.cn/20181102151835255.gif" alt="在这里插入图片描述"></p>
<h2 id="二-代码示例"><a href="#二-代码示例" class="headerlink" title="二.代码示例"></a>二.代码示例</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-cn"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"ie=edge"</span>&gt;</span><br><span class="line">    &lt;title&gt;D3 test&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">        &lt;div id=<span class="string">"graph"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="/</span><span class="keyword">static</span>/js/d3-v4.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var nodes = [ &#123; name: "</span>桂林<span class="string">" &#125;, &#123; name: "</span>广州<span class="string">" &#125;,</span></span><br><span class="line"><span class="string">              &#123; name: "</span>厦门<span class="string">" &#125;, &#123; name: "</span>杭州<span class="string">" &#125;,</span></span><br><span class="line"><span class="string">              &#123; name: "</span>上海<span class="string">" &#125;, &#123; name: "</span>青岛<span class="string">" &#125;,</span></span><br><span class="line"><span class="string">              &#123; name: "</span>天津<span class="string">" &#125; ];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var links = [ &#123; source : 0 , target: 1 &#125; , &#123; source : 0 , target: 2 &#125; ,</span></span><br><span class="line"><span class="string">               &#123; source : 0 , target: 3 &#125; , &#123; source : 1 , target: 4 &#125; ,</span></span><br><span class="line"><span class="string">               &#123; source : 1 , target: 5 &#125; , &#123; source : 1 , target: 6 &#125; ];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var width = 800;</span></span><br><span class="line"><span class="string">    var height = 600;</span></span><br><span class="line">    var svg = d3.select("#graph")</span><br><span class="line">        .append(<span class="string">"svg"</span>)</span><br><span class="line">        .attr(<span class="string">"width"</span>, width)</span><br><span class="line">        .attr(<span class="string">"height"</span>, height)</span><br><span class="line">        .call(d3.zoom() <span class="comment">//创建缩放行为</span></span><br><span class="line">            .scaleExtent([<span class="number">-5</span>, <span class="number">2</span>])</span><br><span class="line">            .on(<span class="string">'zoom'</span>,zoom_actions)); <span class="comment">//设置缩放范围</span></span><br><span class="line">        </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化力学仿真器，通过布局函数格式化数据    </span></span><br><span class="line">    <span class="keyword">var</span> simulation = d3.forceSimulation(nodes)</span><br><span class="line">        .force(<span class="string">"link"</span>, d3.forceLink(links).distance(<span class="number">100</span>))   <span class="comment">//distance设置连线距离</span></span><br><span class="line">        .force(<span class="string">"charge"</span>, d3.forceManyBody().strength(<span class="number">-100</span>))  <span class="comment">//注1&gt; </span></span><br><span class="line">        .force(<span class="string">"center"</span>, d3.forceCenter(width / <span class="number">2</span>, height / <span class="number">2</span>))  <span class="comment">//设置力学仿真器的中心</span></span><br><span class="line">        .on(<span class="string">"tick"</span>, ticked);  </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//布局函数格式化后的数据，注2&gt;</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'nodes'</span>, nodes);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'links'</span>, links);  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> color = d3.scaleOrdinal(d3.schemeCategory20);  <span class="comment">//生成颜色选择器函数，此函数返回颜色数组 (string [])</span></span><br><span class="line">    </span><br><span class="line">     <span class="comment">//添加group包裹svg元素以进行缩放，目的是在缩放时不会影响整个容器的位置</span></span><br><span class="line">    <span class="keyword">var</span> g = svg.append(<span class="string">"g"</span>)</span><br><span class="line">    .attr(<span class="string">"class"</span>, <span class="string">"everything"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制连线</span></span><br><span class="line">    <span class="keyword">var</span> svg_links = g.append(<span class="string">'g'</span>)</span><br><span class="line">        .selectAll(<span class="string">"line"</span>)</span><br><span class="line">        .data(links)</span><br><span class="line">        .enter()</span><br><span class="line">        .append(<span class="string">"line"</span>)</span><br><span class="line">        .style(<span class="string">"stroke"</span>, <span class="string">"#ccc"</span>)</span><br><span class="line">        .style(<span class="string">"stroke-width"</span>, <span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制节点    </span></span><br><span class="line">    <span class="keyword">var</span> svg_nodes = g.append(<span class="string">'g'</span>)</span><br><span class="line">        .selectAll(<span class="string">"circle"</span>)</span><br><span class="line">        .data(nodes)</span><br><span class="line">        .enter()</span><br><span class="line">        .append(<span class="string">"circle"</span>)</span><br><span class="line">        .attr(<span class="string">"r"</span>, <span class="string">'20'</span>)</span><br><span class="line">        .style(<span class="string">"fill"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> color(i);</span><br><span class="line">        &#125;).call(d3.drag().on(<span class="string">"start"</span>, dragstarted) <span class="comment">//d3.drag() 创建一个拖曳行为</span></span><br><span class="line">          .on(<span class="string">"drag"</span>, dragged)</span><br><span class="line">          .on(<span class="string">"end"</span>, dragended));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//绘制描述节点的文字</span></span><br><span class="line">    <span class="keyword">var</span> svg_texts =  g.append(<span class="string">'g'</span>)</span><br><span class="line">        .selectAll(<span class="string">"text"</span>)</span><br><span class="line">        .data(nodes)</span><br><span class="line">        .enter()</span><br><span class="line">        .append(<span class="string">"text"</span>)</span><br><span class="line">        .style(<span class="string">"fill"</span>, <span class="string">"black"</span>)</span><br><span class="line">        .attr(<span class="string">"dx"</span>, <span class="number">20</span>)</span><br><span class="line">        .attr(<span class="string">"dy"</span>, <span class="number">8</span>)</span><br><span class="line">        .text(<span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> d.name;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听拖拽开始    </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dragstarted</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!d3.event.active) simulation.alphaTarget(<span class="number">0.3</span>).restart(); <span class="comment">//alpha是动画的冷却系数，运动过程中会不断减小，直到小于0.005为止，此时动画会停止。</span></span><br><span class="line">        d.fx = d.x;    <span class="comment">//fx为固定坐标，x为初始坐标  注3&gt;  </span></span><br><span class="line">        d.fy = d.y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听拖拽中  </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dragged</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">        d.fx = d3.event.x;  <span class="comment">//fevent.x为拖拽移动时的坐标</span></span><br><span class="line">        d.fy = d3.event.y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听拖拽结束</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dragended</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!d3.event.active) simulation.alphaTarget(<span class="number">0</span>);</span><br><span class="line">        d.fx = <span class="literal">null</span>;        <span class="comment">//固定坐标清空</span></span><br><span class="line">        d.fy = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">zoom_actions</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        g.attr(<span class="string">"transform"</span>, d3.event.transform)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拖拽时的事件监听器  以实时更新坐标</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ticked</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        svg_links.attr(<span class="string">"x1"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.source.x;</span><br><span class="line">            &#125;)</span><br><span class="line">            .attr(<span class="string">"y1"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.source.y;</span><br><span class="line">            &#125;)</span><br><span class="line">            .attr(<span class="string">"x2"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.target.x;</span><br><span class="line">            &#125;)</span><br><span class="line">            .attr(<span class="string">"y2"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.target.y;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        svg_nodes.attr(<span class="string">"cx"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.x;</span><br><span class="line">            &#125;)</span><br><span class="line">            .attr(<span class="string">"cy"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.y;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        svg_texts.attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.x;</span><br><span class="line">            &#125;)</span><br><span class="line">            .attr(<span class="string">"y"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> d.y;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="三-注释详解"><a href="#三-注释详解" class="headerlink" title="三.注释详解"></a>三.注释详解</h2><hr>
<p>相关函数的说明在代码的注释中已经写的很清楚了，下面我针对以上注释中的注1&gt;,2&gt;,3&gt;做一些详细的解释。</p>
<blockquote>
<p><strong>1&gt;  forceManyBody()函数为创建多体力函数，strength为相互作用力，正的为吸力，负的为斥力，何为多体力？你可以把它理解成是一个创建作用力,设置作用力阈值和计算作用力大小的高阶函数</strong></p>
</blockquote>
<p>这是github上D3.js对于<code>forceManyBody()</code>的解释。</p>
<p><img src="https://img-blog.csdnimg.cn/20181029173815955.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<hr>
<p>简单来说，就是此函数可以创建一个带参的多体力对象，此对象中有一些函数，咱们可以调用，具体有如下几个函数：</p>
<p><img src="https://img-blog.csdnimg.cn/20181029173800377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><code>strength</code>,<code>distanceMin</code>和<code>distanceMax</code>都是字面意思，无需多说，我稍微解释下<code>theta</code>函数。</p>
<hr>
<p>我先放上github官网上对于此<code>manyBody.theta()</code>函数的解释。<br><img src="https://img-blog.csdnimg.cn/20181029174800689.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>什么意思呢?简单来说，就是这个函数用来计算你每个节点所受到的其他所有节点的合力的近似值，而<code>theta</code>函数就是用来设置此近似值的精度，官方给了一个默认值是0.9。</p>
<p>我们可以看到，这个函数依赖的是<code>Barnes-Hut</code>算法，那么何为<code>Barnes-Hut</code>?</p>
<blockquote>
<p>Barnes-Hut算法是一种用于实现N体问题（n-body）模拟的近似算法。</p>
</blockquote>
<p><strong>以下是维基百科的解释</strong>：<br><img src="https://img-blog.csdnimg.cn/20181029174004828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上面那一堆东西就是说，这个算法是从节点的根数据开始递归，并遵循一定的原则，最终计算出合力。具体规则如下：</p>
<blockquote>
<p><strong>1.如果当前节点是一个外部节点（而且它不是物体bb），计算当前节点施加在物体bb上的力，并将其加到bb的合力上。<br>2.计算商s/ds/d的值。如果s/d&lt;θs/d&lt;θ，将这个内部节点看成一个单独的物体<br>3.计算其施加在物体bb上的力，并将其加到bb的合力上。否则，在当前节点的每个孩子节点上递归地执行上述步骤。</strong></p>
</blockquote>
<hr>
<blockquote>
<p><strong>2&gt;,3&gt;原始数据被布局函数转化后使什么格式呢？我们可以看下打印后的结果。</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20181030092953652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrMjI5MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>以上参数什么含义呢？</p>
<blockquote>
<p><strong>index - 节点的索引号<br>vx, vy - 节点上一个时刻的坐标<br>x, y - 节点的当前坐标</strong></p>
</blockquote>
<p>拖拽函数中的<code>fx</code>，就对应着节点中的<code>x</code>,是节点的初始横坐标；<code>fy</code>就对应着节点中的<code>y</code>，是节点的初始纵坐标。</p>
<h2 id="四-参考文章"><a href="#四-参考文章" class="headerlink" title="四.参考文章"></a>四.参考文章</h2><hr>
<p> 【1】<a href="https://github.com/d3/d3-force#forceManyBody" target="_blank" rel="noopener">D3.js GitHub</a><br>【2】<a href="https://github.com/tianxuzhang/d3.v4-API-Translation" target="_blank" rel="noopener">D3.js 4.x API中文手册</a><br>【3】<a href="https://blog.csdn.net/baimafujinji/article/details/53036473" target="_blank" rel="noopener">Barnes-Hut算法（quad-tree的一个应用）</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wawisready.github.io/2018/03/30/D3.js创建力导向图(V4)附带详细的参数说明/" data-id="cjtvics95000luovds376ke3a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/D3-js/">D3.js</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/D3-js/">D3.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Echarts/">Echarts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端自动化/">前端自动化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/框架/">框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试题/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/D3-js/" style="font-size: 16.67px;">D3.js</a> <a href="/tags/Echarts/" style="font-size: 10px;">Echarts</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/前端自动化/" style="font-size: 13.33px;">前端自动化</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a> <a href="/tags/面试题/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/03/30/从-Promise-来看-JavaScript-的异步处理/">从 Promise 来看 JavaScript 的异步处理</a>
          </li>
        
          <li>
            <a href="/2018/05/26/UI recorder 自动化UI测试框架使用手册/">UI recorder 自动化UI测试框架使用手册</a>
          </li>
        
          <li>
            <a href="/2018/05/20/原生JS实现并封装前端路由/">原生 JavaScript 实现并封装前端路由</a>
          </li>
        
          <li>
            <a href="/2018/05/19/Karma 自动化测试框架搭建文档/">Karma 自动化测试框架搭建文档</a>
          </li>
        
          <li>
            <a href="/2018/04/06/JavaScript事件委托机制与this的比较/">JavaScript事件委托机制与this的比较</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Eiwen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>